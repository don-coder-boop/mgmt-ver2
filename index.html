<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nuuanu | Seeding Management Tool</title>
    
    <!-- External Libraries (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (UMD) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    
    <!-- Recharts (UMD) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Firebase SDK (Compat version for script-based integration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Helvetica Neue', 'Helvetica', 'Arial', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #ffffff;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Luxury Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #000; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        
        .storage-bar {
            transition: width 0.5s ease-in-out, background-color 0.3s;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
                column-gap: 3rem; 
                row-gap: 8rem;    
            }
        }
        
        input, textarea, select {
            border-radius: 0 !important;
        }

        .text-grey-dark { color: #222222; }
        .text-grey-medium { color: #444444; }
        .text-grey-light { color: #666666; }

        .truncate-custom {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Blue Scheme for Report */
        .bg-nuuanu-blue-soft { background-color: #f0f7ff; }
        .text-nuuanu-blue { color: #2563eb; }
        .border-nuuanu-blue-light { border-color: #dbeafe; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useMemo } = React;
        const Lucide = window.LucideReact || {};
        const RechartsLib = window.Recharts || {};

        const { 
            ShoppingBag, LogOut, Settings, Package, Truck, BarChart3, 
            Plus, ChevronRight, ChevronLeft, X, Upload, Download, 
            Trash2, Copy, CheckCircle2, CheckSquare, Square, Search, FileSpreadsheet,
            AlertCircle, ChevronUp, ChevronDown, Check, Loader2, Cloud
        } = Lucide;

        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, 
            Tooltip: RechartsTooltip, ResponsiveContainer, Cell 
        } = RechartsLib;

        const Icon = ({ name: Comp, ...props }) => Comp ? <Comp {...props} /> : null;

        const firebaseConfig = {
            apiKey: "AIzaSyAFWB4h6BLqXMCfDxdkKd_9F5aXOUPfHI0",
            authDomain: "nuuanu-portal.firebaseapp.com",
            projectId: "nuuanu-portal",
            storageBucket: "nuuanu-portal.firebasestorage.app",
            messagingSenderId: "318424850254",
            appId: "1:318424850254:web:5dc3ad479a7e4b264b081f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const CLOUDINARY_CLOUD_NAME = 'dtjkkzj00';
        const CLOUDINARY_UPLOAD_PRESET = 'nuuanu seeding preset';

        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) throw new Error('Upload failed');
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw error;
            }
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; }
                    else if (char === '"') inQuotes = false;
                    else currentField += char;
                } else {
                    if (char === '"') inQuotes = true;
                    else if (char === ',') { currentRow.push(currentField); currentField = ''; }
                    else if (char === '\n' || char === '\r') {
                        if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); currentRow = []; currentField = ''; }
                        if (char === '\r' && nextChar === '\n') i++;
                    } else currentField += char;
                }
            }
            if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); }
            return rows;
        };

        const downloadCSV = (filename, data) => {
            if (data.length === 0) return;
            const headers = ["instagram ID", "이름", "전화번호", "받는분기타연락처", "받는분우편번호", "주소", "제품명", "사이즈", "수량", "배송메세지1"];
            const csvRows = [headers.join(',')];
            data.forEach(item => {
                const escape = (val) => `"${String(val || "").replace(/"/g, '""')}"`;
                csvRows.push([
                    escape(item.instagramId), escape(item.name), escape(item.phone),
                    escape(""), escape(""), escape(item.address),
                    escape(item.productName), escape(item.size), escape(1), escape(item.message)
                ].join(','));
            });
            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        const Toast = ({ error, success }) => {
            if (error) return (
                <div className="fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-3 text-[10px] tracking-[0.1em] uppercase font-bold z-[1000] shadow-xl">
                    {error}
                </div>
            );
            if (success) return (
                <div className="fixed top-0 left-0 right-0 bg-black text-white text-center py-3 text-[10px] tracking-[0.1em] uppercase z-[1000] shadow-xl">
                    {success}
                </div>
            );
            return null;
        };

        const SyncMonitor = () => (
            <div className="fixed bottom-6 right-6 bg-white border border-gray-100 p-4 shadow-2xl z-50 min-w-[180px] animate-fade-in flex items-center space-x-3">
                <div className="flex-shrink-0">
                    <Icon name={Cloud} size={18} className="text-green-500" />
                </div>
                <div className="flex flex-col">
                    <span className="text-[9px] tracking-[0.075em] text-grey-medium uppercase font-bold">Cloud Sync</span>
                    <span className="text-[8px] text-green-600 uppercase font-medium">Real-time Connected</span>
                </div>
            </div>
        );

        const AdminDashboard = ({ collection, collections, onUpdate, onBack, activeSubView, setSubView, notify, adminAccessCode, updateAdminCode, onDelete, error, success }) => {
            const [selectedRows, setSelectedRows] = useState(new Set());
            const [sortConfig, setSortConfig] = useState({ key: 'submitDate', direction: 'desc' });
            const [isUploading, setIsUploading] = useState(false);

            const handleUpdate = (u, skipNotify = false) => { 
                onUpdate({ ...collection, ...u }); 
                if (!skipNotify) notify('Cloud Sync Saved', 'success'); 
            };

            const isCodeGloballyUnique = (code, currentCollectionId, codesInThisCollection = []) => {
                if (!code || code.trim() === '') return true;
                const lowerCode = code.toLowerCase().trim();
                
                // 1. Check Admin Code
                if (lowerCode === adminAccessCode.toLowerCase().trim()) return false;

                // 2. Check other collections
                const existsInOtherCollection = collections.some(c => {
                    if (c.id === currentCollectionId) return false;
                    const codes = c.accessCodesV2 || [];
                    return codes.some(ac => ac.code.toLowerCase().trim() === lowerCode);
                });
                if (existsInOtherCollection) return false;

                // 3. Check within current collection list for duplicates (other than itself)
                const localMatches = codesInThisCollection.filter(ac => ac.code.toLowerCase().trim() === lowerCode);
                if (localMatches.length > 1) return false;

                return true;
            };

            const handleCodeBulkUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const content = evt.target.result;
                    const rows = parseCSV(content);
                    if (rows.length < 2) return;
                    
                    const newCodes = [];
                    const currentCodes = collection.accessCodesV2 || [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (!cols || cols.length < 1) continue;
                        const code = cols[0]?.trim();
                        const limit = cols[1];
                        
                        if (code) {
                            // Check if unique globally and not already in our new list or existing list
                            const combinedTemp = [...currentCodes, ...newCodes];
                            if (isCodeGloballyUnique(code, collection.id, [...combinedTemp, { code }])) {
                                newCodes.push({ code: code, limit: parseInt(limit) || 2 });
                            }
                        }
                    }
                    if (newCodes.length > 0) {
                        handleUpdate({ accessCodesV2: [...currentCodes, ...newCodes] });
                        notify(`${newCodes.length} codes imported`, 'success');
                    } else {
                        notify('No valid or unique codes found in CSV', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const content = evt.target.result;
                    const rows = parseCSV(content);
                    if (rows.length < 2) return;
                    const newProducts = [];
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (!cols || cols.length < 4) continue;
                        const [name, price, optionStr, summary] = cols;
                        let options = ['OS'];
                        const match = (optionStr || '').match(/size\{([^}]+)\}/i);
                        if (match) options = match[1].split('|');
                        newProducts.push({ id: generateId(), name: name || 'New Item', price: price || '0', options: options, description: summary || '', images: [] });
                    }
                    if (newProducts.length > 0) {
                        handleUpdate({ products: [...collection.products, ...newProducts] });
                        notify(`${newProducts.length} items added`, 'success');
                    }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const sortedShipping = useMemo(() => {
                const data = [...collection.shippingEntries];
                if (!sortConfig.key) return data;
                return data.sort((a, b) => {
                    const valA = String(a[sortConfig.key] || '').toLowerCase();
                    const valB = String(b[sortConfig.key] || '').toLowerCase();
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [collection.shippingEntries, sortConfig]);

            const handleBulkStatusChange = (newStatus) => {
                if (selectedRows.size === 0) return;
                const next = collection.shippingEntries.map(e => selectedRows.has(e.id) ? { ...e, status: newStatus } : e);
                handleUpdate({ shippingEntries: next });
                setSelectedRows(new Set());
            };

            const toggleRow = (id) => {
                const next = new Set(selectedRows);
                if (next.has(id)) next.delete(id); else next.add(id);
                setSelectedRows(next);
            };

            const toggleAll = () => {
                if (selectedRows.size === sortedShipping.length && sortedShipping.length > 0) setSelectedRows(new Set());
                else setSelectedRows(new Set(sortedShipping.map(e => e.id)));
            };

            const handleSort = (key) => {
                setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
            };

            const renderSortIcon = (key) => {
                if (sortConfig.key !== key) return <Icon name={ChevronDown} size={14} className="opacity-0 group-hover:opacity-30 ml-1" />;
                return sortConfig.direction === 'asc' ? <Icon name={ChevronUp} size={14} className="ml-1" /> : <Icon name={ChevronDown} size={14} className="ml-1" />;
            };

            const truncateText = (text, len = 10) => {
                if (!text) return '';
                if (text.length <= len) return text;
                return text.substring(0, len) + '...';
            };

            const handleExport = () => {
                const dataToExport = selectedRows.size > 0 
                    ? collection.shippingEntries.filter(e => selectedRows.has(e.id))
                    : collection.shippingEntries;
                downloadCSV(`${collection.name}_shipments.csv`, dataToExport);
            };

            const handleLookbookUpload = async (e) => {
                if (!e.target.files) return;
                setIsUploading(true);
                try {
                    const uploads = Array.from(e.target.files).map(f => uploadToCloudinary(f));
                    const urls = await Promise.all(uploads);
                    handleUpdate({ lookbookImages: [...collection.lookbookImages, ...urls] });
                    notify(`${urls.length} images uploaded`, 'success');
                } catch (err) {
                    notify('Upload failed. Check connection.', 'error');
                } finally {
                    setIsUploading(false);
                }
            };

            const handleProductImageUpload = async (productId, e) => {
                if (!e.target.files) return;
                setIsUploading(true);
                try {
                    const uploads = Array.from(e.target.files).map(f => uploadToCloudinary(f));
                    const urls = await Promise.all(uploads);
                    const updatedProducts = collection.products.map(p => 
                        p.id === productId ? { ...p, images: [...p.images, ...urls] } : p
                    );
                    handleUpdate({ products: updatedProducts });
                    notify(`${urls.length} images uploaded`, 'success');
                } catch (err) {
                    notify('Upload failed.', 'error');
                } finally {
                    setIsUploading(false);
                }
            };

            const accessCodes = collection.accessCodesV2 || [{ code: collection.accessCode || '', limit: collection.maxProducts || 1 }];

            return (
                <div className="min-h-screen bg-white flex flex-col animate-fade-in">
                    <header className="border-b border-gray-100 py-8 px-12 flex justify-between items-center bg-white sticky top-0 z-40 backdrop-blur-md bg-white/90">
                        <div className="flex items-center space-x-12">
                            <button onClick={onBack} className="text-[15px] uppercase tracking-[0.075em] flex items-center hover:text-gray-400 font-bold group">
                                <Icon name={ChevronLeft} size={22} className="mr-2 group-hover:-translate-x-1 transition-transform" /> Back
                            </button>
                            <h2 className="text-[18px] font-bold tracking-[0.1em] uppercase">{collection.name}</h2>
                        </div>
                        <nav className="flex space-x-16">
                            {[{id:'settings', label:'Settings', icon:Settings}, {id:'products', label:'Products', icon:Package}, {id:'shipping', label:'Shipping', icon:Truck}, {id:'report', label:'Report', icon:BarChart3}].map(tab => (
                                <button key={tab.id} onClick={() => setSubView(tab.id)} className={`flex items-center space-x-3 text-[15px] uppercase tracking-[0.075em] py-2 ${activeSubView === tab.id ? 'text-black font-bold border-b-2 border-black' : 'text-grey-medium hover:text-black'}`}>
                                    <Icon name={tab.icon} size={20} /> <span className="hidden md:inline">{tab.label}</span>
                                </button>
                            ))}
                        </nav>
                    </header>
                    <main className="flex-1 p-12 overflow-auto">
                        {isUploading && (
                            <div className="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black text-white px-8 py-4 flex items-center space-x-4 shadow-2xl">
                                <div className="loader"></div>
                                <span className="text-[12px] font-bold uppercase tracking-normal">Uploading to Cloudinary...</span>
                            </div>
                        )}
                        {activeSubView === 'settings' && (
                            <div className="max-w-5xl mx-auto space-y-20 py-10">
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Global Configuration</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                                        <div className="space-y-4">
                                            <label className="text-[14px] text-grey-medium uppercase font-bold tracking-normal">Admin Access Code</label>
                                            <input type="text" className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" value={adminAccessCode} onChange={e => updateAdminCode(e.target.value)} />
                                        </div>
                                    </div>
                                </section>
                                <section className="space-y-10">
                                    <div className="flex justify-between items-center border-b pb-6">
                                        <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Influencer Access Codes</h3>
                                        <div className="flex space-x-4">
                                            <label className="text-[14px] uppercase font-bold text-black border-2 border-black px-6 py-2 flex items-center cursor-pointer hover:bg-black hover:text-white transition-colors">
                                                <Icon name={FileSpreadsheet} size={18} className="mr-2"/> Bulk Upload
                                                <input type="file" accept=".csv" className="hidden" onChange={handleCodeBulkUpload} />
                                            </label>
                                            <button onClick={() => {
                                                const newCode = { code: generateId().substring(0,6), limit: 2 };
                                                handleUpdate({ accessCodesV2: [...accessCodes, newCode] });
                                            }} className="text-[14px] uppercase font-bold text-white bg-black px-6 py-2 flex items-center"><Icon name={Plus} size={18} className="mr-2"/> Add Code</button>
                                        </div>
                                    </div>
                                    <div className="grid gap-8">
                                        {accessCodes.map((ac, idx) => {
                                            const isUnique = isCodeGloballyUnique(ac.code, collection.id, accessCodes);
                                            return (
                                                <div key={idx} className={`flex flex-col sm:flex-row items-center gap-10 p-8 border transition-colors ${!isUnique ? 'border-red-500 bg-red-50' : 'bg-gray-50/30'}`}>
                                                    <div className="flex-1 space-y-4 w-full">
                                                        <label className="text-[12px] text-grey-light uppercase tracking-normal font-bold">Code</label>
                                                        <div className="relative">
                                                            <input 
                                                                type="text" 
                                                                className={`w-full bg-white border-b-2 py-3 px-3 outline-none text-[16px] uppercase transition-colors ${!isUnique ? 'border-red-500 focus:border-red-600' : 'focus:border-black'}`} 
                                                                value={ac.code} 
                                                                onChange={e => {
                                                                    const codes = [...accessCodes];
                                                                    codes[idx].code = e.target.value.trim();
                                                                    // We update local state, but uniqueness check will flag it
                                                                    handleUpdate({ accessCodesV2: codes }, true);
                                                                }} 
                                                            />
                                                            {!isUnique && (
                                                                <div className="mt-2 text-[10px] text-red-600 font-bold uppercase tracking-tight flex items-center">
                                                                    <Icon name={AlertCircle} size={14} className="mr-1"/> 이미 사용 중인 코드입니다. 다른 코드를 입력해주세요.
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="w-full sm:w-40 space-y-4">
                                                        <label className="text-[12px] text-grey-light uppercase tracking-normal font-bold">Item Limit</label>
                                                        <input type="number" className="w-full bg-white border-b-2 py-3 px-3 focus:border-black outline-none text-[16px]" value={ac.limit} onChange={e => {
                                                            const codes = [...accessCodes];
                                                            codes[idx].limit = parseInt(e.target.value) || 1;
                                                            handleUpdate({ accessCodesV2: codes }, true);
                                                        }} />
                                                    </div>
                                                    <button onClick={() => handleUpdate({ accessCodesV2: accessCodes.filter((_, i) => i !== idx) })} className="p-3 bg-black text-white hover:bg-black/80 transition-colors rounded"><Icon name={Trash2} size={20}/></button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Story & Details</h3>
                                    <input placeholder="TITLE" className="w-full text-5xl font-light tracking-normal border-b-2 py-6 outline-none focus:border-black" value={collection.descriptionTitle} onChange={e => handleUpdate({ descriptionTitle: e.target.value }, true)} />
                                    <textarea placeholder="CONTENT" className="w-full h-64 border-2 p-10 text-[16px] font-light outline-none focus:border-black leading-relaxed" value={collection.descriptionBody} onChange={e => handleUpdate({ descriptionBody: e.target.value }, true)} />
                                </section>
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Lookbook Images (1:1.5)</h3>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 lg:gap-0">
                                        {collection.lookbookImages.map((img, i) => (
                                            <div key={i} className="relative aspect-[1/1.5] group bg-gray-50 border overflow-hidden shadow-sm">
                                                <img src={img} className="w-full h-full object-cover" />
                                                <button onClick={() => { const next = [...collection.lookbookImages]; next.splice(i, 1); handleUpdate({ lookbookImages: next }); }} className="absolute top-4 right-4 bg-white/80 p-3 opacity-0 group-hover:opacity-100 shadow-xl transition-opacity"><Icon name={X} size={20}/></button>
                                            </div>
                                        ))}
                                        <label className={`aspect-[1/1.5] border-2 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-black transition-all group ${isUploading ? 'opacity-50 pointer-events-none' : ''}`}>
                                            <Icon name={isUploading ? Loader2 : Upload} size={32} className={`text-gray-200 group-hover:text-black ${isUploading ? 'animate-spin' : ''}`} />
                                            <input type="file" multiple className="hidden" onChange={handleLookbookUpload} />
                                        </label>
                                    </div>
                                </section>
                                <div className="pt-24 text-center"><button onClick={onDelete} className="text-red-400 text-[14px] uppercase font-bold px-16 py-5 bg-red-50 rounded-full hover:bg-red-100 transition-colors">Delete Entire Collection</button></div>
                            </div>
                        )}
                        {activeSubView === 'products' && (
                            <div className="max-w-6xl mx-auto space-y-16">
                                <div className="flex justify-between items-end border-b pb-8">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Product Catalog</h3>
                                    <div className="flex space-x-6">
                                        <label className="bg-white border-2 border-black text-black px-10 py-4 text-[14px] uppercase font-bold cursor-pointer hover:bg-black hover:text-white transition-all flex items-center">
                                            <Icon name={FileSpreadsheet} size={20} className="mr-3" /> Bulk Upload
                                            <input type="file" accept=".csv" className="hidden" onChange={handleCSVUpload} />
                                        </label>
                                        <button onClick={() => handleUpdate({ products: [...collection.products, { id: generateId(), name: 'New Item', price: '0', options: ['OS'], description: '', images: [] }] })} className="bg-black text-white px-12 py-4 text-[14px] uppercase font-bold flex items-center"><Icon name={Plus} size={20} className="mr-3" /> Add Product</button>
                                    </div>
                                </div>
                                <div className="grid gap-16">
                                    {collection.products.map(p => (
                                        <div key={p.id} className="border-2 p-12 flex flex-col xl:flex-row gap-16 bg-white hover:shadow-2xl transition-all">
                                            <div className="flex-1 grid gap-12 md:grid-cols-2">
                                                <div className="space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Name</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[18px] font-bold" value={p.name} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, name: e.target.value} : x) }, true)} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Price</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" value={p.price} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, price: e.target.value} : x) }, true)} />
                                                </div>
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Options</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" placeholder="Sizes (e.g. 1, 2, 3)" value={p.options.join(',')} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, options: e.target.value.split(',')} : x) }, true)} />
                                                </div>
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Summary</label>
                                                    <textarea className="w-full h-48 border-2 p-6 focus:border-black outline-none text-[16px] leading-relaxed" placeholder="Product Details" value={p.description} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, description: e.target.value} : x) }, true)} />
                                                </div>
                                            </div>
                                            <div className="xl:w-80 space-y-8">
                                                <div className="grid grid-cols-3 gap-3">
                                                    {p.images.map((img, i) => (
                                                        <div key={i} className="aspect-[2/3] relative group border overflow-hidden shadow-sm"><img src={img} className="w-full h-full object-cover"/><button onClick={() => { const ni = [...p.images]; ni.splice(i, 1); handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, images: ni} : x) }); }} className="absolute top-2 right-2 bg-white p-2 opacity-0 group-hover:opacity-100 shadow transition-opacity"><Icon name={X} size={14}/></button></div>
                                                    ))}
                                                    <label className={`aspect-[2/3] border-2 border-dashed flex items-center justify-center cursor-pointer hover:border-black transition-colors ${isUploading ? 'opacity-50 pointer-events-none' : ''}`}>
                                                        <Icon name={isUploading ? Loader2 : Plus} size={24} className={isUploading ? 'animate-spin' : ''} />
                                                        <input type="file" multiple className="hidden" onChange={(e) => handleProductImageUpload(p.id, e)} />
                                                    </label>
                                                </div>
                                                <button onClick={() => { if(confirm('Remove this product?')) handleUpdate({ products: collection.products.filter(x => x.id !== p.id) }); }} className="text-red-500 text-[14px] uppercase font-bold w-full pt-6 border-t-2 border-dashed">Remove Item</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeSubView === 'shipping' && (
                            <div className="space-y-8">
                                <div className="flex justify-between items-center border-b pb-8">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Seeding Management Table</h3>
                                    <div className="flex space-x-6 items-center">
                                        {selectedRows.size > 0 && (
                                            <div className="flex space-x-3 bg-gray-50 p-3 rounded items-center">
                                                <span className="text-[14px] uppercase font-bold text-grey-medium px-4">{selectedRows.size} selected</span>
                                                <button onClick={() => handleBulkStatusChange('배송완료')} className="text-[14px] font-bold uppercase bg-black text-white px-6 py-3 transition-colors hover:bg-black/90">Set Delivered</button>
                                                <button onClick={() => handleBulkStatusChange('준비중')} className="text-[14px] font-bold uppercase border-2 border-black px-6 py-3 transition-colors hover:bg-black hover:text-white">Set Preparing</button>
                                            </div>
                                        )}
                                        <button onClick={handleExport} className="text-[14px] font-bold uppercase border-2 border-black px-10 py-3 hover:bg-black hover:text-white transition-all">
                                            {selectedRows.size > 0 ? `Export ${selectedRows.size} Selected` : 'Export All CSV'}
                                        </button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto border-2">
                                    <table className="w-full text-left text-[16px] min-w-[1400px]">
                                        <thead className="bg-gray-50 uppercase text-[12px] tracking-[0.05em] text-grey-medium border-b-2 sticky top-0 z-10">
                                            <tr>
                                                <th className="p-6 w-16 text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        className="w-4 h-4" 
                                                        checked={selectedRows.size === sortedShipping.length && sortedShipping.length > 0}
                                                        onChange={toggleAll}
                                                    />
                                                </th>
                                                {[
                                                    { key: 'status', label: 'Status' },
                                                    { key: 'submitDate', label: 'Date' },
                                                    { key: 'instagramId', label: 'Insta ID' },
                                                    { key: 'name', label: 'Name' },
                                                    { key: 'phone', label: 'Phone' },
                                                    { key: 'address', label: 'Address' },
                                                    { key: 'productName', label: 'Product' },
                                                    { key: 'size', label: 'Size' },
                                                    { key: 'adminMemo', label: 'Admin Memo' }
                                                ].map(col => (
                                                    <th 
                                                        key={col.key} 
                                                        className={`p-6 cursor-pointer hover:text-black group select-none whitespace-nowrap`}
                                                        onClick={() => handleSort(col.key)}
                                                    >
                                                        <div className="flex items-center">
                                                            {col.label} {renderSortIcon(col.key)}
                                                        </div>
                                                    </th>
                                                ))}
                                                <th className="p-6 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y-2 divide-gray-100">
                                            {sortedShipping.map(e => (
                                                <tr key={e.id} className={`${selectedRows.has(e.id) ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-50/50 transition-colors`}>
                                                    <td className="p-6 text-center">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4" 
                                                            checked={selectedRows.has(e.id)}
                                                            onChange={() => toggleRow(e.id)}
                                                        />
                                                    </td>
                                                    <td className="p-6">
                                                        <select className={`text-[12px] px-3 py-2 border-2 font-bold uppercase bg-white ${e.status === '배송완료' ? 'text-green-600 border-green-100 bg-green-50' : 'text-orange-600 border-orange-100 bg-orange-50'}`} value={e.status} onChange={val => handleUpdate({ shippingEntries: collection.shippingEntries.map(x => x.id === e.id ? {...x, status: val.target.value} : x) })}>
                                                            <option value="준비중">준비중</option>
                                                            <option value="배송완료">배송완료</option>
                                                        </select>
                                                    </td>
                                                    <td className="p-6 whitespace-nowrap text-grey-medium font-mono text-[14px]">{e.submitDate}</td>
                                                    <td className="p-6 font-bold uppercase">@{e.instagramId}</td>
                                                    <td className="p-6">{e.name}</td>
                                                    <td className="p-6 whitespace-nowrap truncate-custom" title={e.phone}>{truncateText(e.phone, 3)}</td>
                                                    <td className="p-6 truncate-custom" title={e.address}>{truncateText(e.address, 3)}</td>
                                                    <td className="p-6">
                                                        <input className="w-full bg-transparent border-b-2 border-transparent focus:border-black outline-none px-2 py-1" value={e.productName} placeholder="Product Name" onChange={v => handleUpdate({ shippingEntries: collection.shippingEntries.map(x => x.id === e.id ? {...x, productName: v.target.value} : x) }, true)} />
                                                    </td>
                                                    <td className="p-6">
                                                        <input className="w-full bg-transparent border-b-2 border-transparent focus:border-black outline-none px-2 py-1 uppercase" value={e.size} placeholder="Size" onChange={v => handleUpdate({ shippingEntries: collection.shippingEntries.map(x => x.id === e.id ? {...x, size: v.target.value} : x) }, true)} />
                                                    </td>
                                                    <td className="p-6">
                                                        <textarea className="w-full h-12 text-[14px] border-2 bg-transparent p-2 focus:bg-white focus:h-24 transition-all outline-none leading-normal" placeholder="Add Memo..." value={e.adminMemo || ''} onChange={v => handleUpdate({ shippingEntries: collection.shippingEntries.map(x => x.id === e.id ? {...x, adminMemo: v.target.value} : x) }, true)} />
                                                    </td>
                                                    <td className="p-6 text-right">
                                                        <div className="flex justify-end space-x-3">
                                                            <button onClick={()=>{ handleUpdate({shippingEntries:[...collection.shippingEntries, {...e, id: generateId(), submitDate:'추가 제품', productName:'', size:'', status: '준비중'}]}); }} className="p-2 bg-black text-white hover:bg-black/80 transition-transform rounded flex items-center justify-center" title="복사"><Icon name={Copy} size={20}/></button>
                                                            <button onClick={() => { if(confirm('Delete record?')) handleUpdate({ shippingEntries: collection.shippingEntries.filter(x => x.id !== e.id) }); }} className="p-2 bg-black text-white hover:bg-red-600 transition-transform rounded flex items-center justify-center" title="삭제"><Icon name={Trash2} size={20}/></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeSubView === 'report' && (
                            <div className="max-w-6xl mx-auto space-y-20">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-12">
                                    <div className="bg-nuuanu-blue-soft p-16 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[15px] text-nuuanu-blue uppercase font-bold tracking-[0.075em]">Total Entries</p>
                                        <p className="text-7xl font-light text-nuuanu-blue">{collection.shippingEntries.length}</p>
                                    </div>
                                    <div className="bg-nuuanu-blue-soft p-16 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[15px] text-nuuanu-blue uppercase font-bold tracking-[0.075em]">Influencer Requests</p>
                                        <p className="text-7xl font-light text-nuuanu-blue">{collection.shippingEntries.filter(s => s.submitDate !== '추가 제품').length}</p>
                                    </div>
                                    <div className="bg-nuuanu-blue-soft p-16 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[15px] text-nuuanu-blue uppercase font-bold tracking-[0.075em]">Completion Rate</p>
                                        <p className="text-7xl font-light text-nuuanu-blue">{collection.shippingEntries.length ? Math.round((collection.shippingEntries.filter(s => s.status === '배송완료').length / collection.shippingEntries.length) * 100) : 0}%</p>
                                    </div>
                                </div>
                                <div className="bg-white p-16 border-2 h-[600px] shadow-sm rounded-xl">
                                    <h3 className="text-[18px] font-bold uppercase tracking-[0.125em] mb-12 border-b-2 pb-8">Product Popularity</h3>
                                    <ResponsiveContainer width="100%" height="80%">
                                        <BarChart data={Object.values(collection.shippingEntries.reduce((acc, curr) => { 
                                            if (!curr.productName) return acc; 
                                            const n = curr.productName.toUpperCase(); 
                                            acc[n] = acc[n] || { name: n, count: 0 }; 
                                            acc[n].count += 1; 
                                            return acc; 
                                        }, {}))}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={{fontSize: 12, fill:'#64748b'}} axisLine={false} tickLine={false}/>
                                            <YAxis tick={{fontSize: 12, fill:'#64748b'}} axisLine={false} tickLine={false}/>
                                            <RechartsTooltip cursor={{fill: '#f1f5f9'}} contentStyle={{ borderRadius: '8px', border: '1px solid #dbeafe'}} />
                                            <Bar dataKey="count" fill="#2563eb" radius={[6, 6, 0, 0]} barSize={40} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                    </main>
                    <SyncMonitor />
                    <Toast error={error} success={success} />
                </div>
            );
        };

        const InfluencerPage = ({ collection, cart, setCart, onLogout, notify, onSubmission, scrollPosRef, error, success, loginCode }) => {
            const [view, setView] = useState('lookbook');
            const [activeSlide, setActiveSlide] = useState(0);
            const [selectedProd, setSelectedProd] = useState(null);
            const [selectedSize, setSelectedSize] = useState('');
            const [formData, setFormData] = useState({ instagramId: '', name: '', phone: '', address: '', message: '', extra: '', agreed: false });
            
            const currentLimit = useMemo(() => {
                const acs = collection.accessCodesV2 || [];
                const found = acs.find(a => a.code.toLowerCase().trim() === loginCode.toLowerCase().trim());
                return found ? found.limit : (collection.maxProducts || 1);
            }, [collection, loginCode]);

            useLayoutEffect(() => { 
                if (view === 'lookbook' && scrollPosRef.current > 0) setTimeout(() => window.scrollTo({ top: scrollPosRef.current, behavior: 'instant' }), 0); 
            }, [view]);

            const handleNav = (v) => { 
                if (view === 'lookbook') scrollPosRef.current = window.scrollY; 
                setView(v); window.scrollTo(0, 0); 
            };

            const next = () => { if(!collection.lookbookImages.length) return; setActiveSlide(p => (p + 2) >= collection.lookbookImages.length ? 0 : p + 2); };
            const prev = () => { if(!collection.lookbookImages.length) return; setActiveSlide(p => p - 2 < 0 ? Math.max(0, collection.lookbookImages.length - (collection.lookbookImages.length % 2 || 2)) : p - 2); };
            
            const addToCart = () => { 
                if(!selectedProd || !selectedSize) { alert('Select size preference'); return; } 
                if(cart.length >= currentLimit) { alert(`Selection limit reached: ${currentLimit} items.`); return; } 
                setCart([...cart, { id: generateId(), productName: selectedProd.name, size: selectedSize, image: selectedProd.images[0] || 'https://picsum.photos/400/600' }]); 
                notify('Added to selection', 'success'); 
                handleNav('lookbook'); 
            };

            const submit = () => { 
                if(!formData.instagramId || !formData.name || !formData.phone || !formData.address || !formData.agreed) { alert('Check required fields and agreement'); return; } 
                onSubmission(cart.map(item => ({ id: generateId(), status: '준비중', submitDate: new Date().toISOString().split('T')[0], ...formData, productName: item.productName, size: item.size, quantity: 1, adminMemo: '' }))); 
                setView('success'); setCart([]); 
            };

            if (view === 'success') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-12 text-center space-y-12 animate-fade-in">
                    <Icon name={CheckCircle2} size={80} strokeWidth={1}/>
                    <h2 className="text-2xl font-light tracking-[0.1em] uppercase">Complete</h2>
                    <p className="text-sm font-light text-grey-medium max-w-sm">Thank you, nuuanu girl! We love having you as part of our journey✨</p>
                    <button onClick={onLogout} className="text-[10px] tracking-[0.125em] border-b border-black pb-1 uppercase font-bold">Sign Out</button>
                </div>
            );

            return (
                <div className="min-h-screen bg-white pb-40 animate-fade-in">
                    <header className="px-10 py-10 sticky top-0 bg-white/95 backdrop-blur-md z-40 flex justify-between items-center border-b border-gray-50">
                        <h1 className="text-2xl font-light tracking-[0.125em] uppercase cursor-pointer" onClick={() => handleNav('lookbook')}>nuuanu</h1>
                        <div className="flex items-center space-x-6">
                            <button onClick={() => handleNav('cart')} className="relative flex items-center group transition-transform active:scale-90">
                                <Icon name={ShoppingBag} size={28} strokeWidth={1.2} />
                                {cart.length > 0 && <span className="absolute -top-1 -right-2 bg-black text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold tracking-normal">{cart.length}</span>}
                            </button>
                            <button onClick={onLogout} className="flex items-center space-x-1 text-[10px] uppercase font-bold tracking-[0.05em] text-grey-medium hover:text-black transition-colors">
                                <Icon name={LogOut} size={20} strokeWidth={1.5}/>
                                <span className="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </header>
                    {view === 'lookbook' && (
                        <main className="animate-fade-in">
                            <section className="relative mb-40 px-0 py-20">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:gap-0 max-w-7xl mx-auto">
                                    {collection.lookbookImages.length > 0 ? (
                                        <>
                                            <div className="aspect-[1/1.5] bg-gray-50 shadow-2xl overflow-hidden">
                                                <img src={collection.lookbookImages[activeSlide]} className="w-full h-full object-cover" />
                                            </div>
                                            <div className="hidden md:block aspect-[1/1.5] bg-gray-50 shadow-2xl overflow-hidden">
                                                <img src={collection.lookbookImages[activeSlide+1] || collection.lookbookImages[0]} className="w-full h-full object-cover" />
                                            </div>
                                        </>
                                    ) : (
                                        <div className="col-span-2 aspect-[2/1.5] bg-gray-50 flex items-center justify-center text-[10px] tracking-[0.1em] text-grey-medium uppercase">Lookbook coming soon</div>
                                    )}
                                </div>
                                {collection.lookbookImages.length > 2 && (
                                    <div className="absolute top-1/2 -translate-y-1/2 left-0 w-full flex justify-between px-4 sm:px-16 pointer-events-none">
                                        <button onClick={prev} className="pointer-events-auto bg-white/70 p-4 rounded-full shadow-2xl hover:bg-white transition-all">
                                            <Icon name={ChevronLeft} size={24} strokeWidth={1}/>
                                        </button>
                                        <button onClick={next} className="pointer-events-auto bg-white/70 p-4 rounded-full shadow-2xl hover:bg-white transition-all">
                                            <Icon name={ChevronRight} size={24} strokeWidth={1}/>
                                        </button>
                                    </div>
                                )}
                            </section>
                            <section className="max-w-2xl mx-auto text-center mb-52 px-10 space-y-12">
                                <h2 className="text-2xl font-light tracking-[0.125em] uppercase border-b border-gray-100 pb-10 inline-block">{collection.descriptionTitle}</h2>
                                <div className="text-sm font-light leading-relaxed tracking-[0.05em] text-grey-dark" dangerouslySetInnerHTML={{ __html: collection.descriptionBody.replace(/\n/g, '<br/>') }} />
                            </section>
                            <section className="max-w-6xl mx-auto px-10">
                                <div className="flex justify-between items-end border-b border-gray-50 pb-10 mb-20">
                                    <div><h3 className="text-[12px] font-bold uppercase tracking-[0.125em]">The Selection</h3></div>
                                    <p className="text-[10px] text-grey-medium uppercase tracking-[0.1em] font-bold">Limit: {cart.length} / {currentLimit}</p>
                                </div>
                                <div className="product-grid">
                                    {collection.products.map(p => (
                                        <div key={p.id} className="group cursor-pointer" onClick={() => { setSelectedProd(p); handleNav('product_detail'); }}>
                                            <div className="aspect-[2/3] bg-gray-50 mb-1 overflow-hidden relative shadow-lg transition-all duration-1000">
                                                <img src={p.images[0] || 'https://picsum.photos/seed/nuuanu/400/600'} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-[2000ms]" />
                                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-all duration-700" />
                                            </div>
                                            <div className="space-y-1">
                                                <h4 className="text-[12px] font-bold tracking-[0.075em] uppercase">{p.name}</h4>
                                                <p className="text-[10px] text-grey-medium uppercase tracking-[0.05em]">KRW {p.price}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        </main>
                    )}
                    {view === 'product_detail' && selectedProd && (
                        <main className="max-w-6xl mx-auto px-10 pt-16 animate-fade-in">
                            <button onClick={() => handleNav('lookbook')} className="text-[11px] tracking-[0.1em] uppercase mb-24 flex items-center hover:text-gray-400 font-bold">
                                <Icon name={ChevronLeft} size={18} className="mr-1" strokeWidth={1} /> Back
                            </button>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-32">
                                <div className="space-y-10">
                                    <div className="aspect-[2/3] bg-gray-50 shadow-2xl overflow-hidden">
                                        <img src={selectedProd.images[0] || 'https://picsum.photos/400/600'} className="w-full h-full object-cover" />
                                    </div>
                                    <div className="grid grid-cols-4 gap-6">
                                        {selectedProd.images.slice(1).map((img, i) => (
                                            <div key={i} className="aspect-[2/3] bg-gray-50 border border-gray-100 shadow-xl overflow-hidden">
                                                <img src={img} className="w-full h-full object-cover" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-20">
                                    <div className="space-y-6 border-b pb-12 border-gray-100">
                                        <h2 className="text-2xl font-light tracking-[0.075em] uppercase">{selectedProd.name}</h2>
                                        <p className="text-grey-medium tracking-[0.125em] text-sm uppercase font-light">Reference: KRW {selectedProd.price}</p>
                                    </div>
                                    <div className="text-sm leading-relaxed text-grey-dark font-light" dangerouslySetInnerHTML={{ __html: (selectedProd.description || '').replace(/\n/g, '<br/>') }} />
                                    <div className="space-y-10">
                                        <p className="text-[11px] tracking-[0.125em] uppercase font-bold">Size Preference</p>
                                        <div className="flex flex-wrap gap-5">
                                            {selectedProd.options.map(s => (
                                                <button key={s} onClick={() => setSelectedSize(s)} className={`min-w-[100px] py-4 border tracking-[0.1em] text-[11px] font-bold transition-all ${selectedSize === s ? 'bg-black text-white border-black shadow-2xl scale-110' : 'border-gray-200 hover:border-black'}`}>{s}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-10">
                                        <button onClick={addToCart} className="w-full bg-black text-white py-8 text-[11px] tracking-[0.15em] font-bold shadow-2xl active:scale-[0.98] uppercase">Add to My Selection</button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    )}
                    {view === 'cart' && (
                        <main className="max-w-2xl mx-auto px-10 pt-16 animate-fade-in">
                            <button onClick={() => handleNav('lookbook')} className="text-[11px] tracking-[0.1em] uppercase mb-24 flex items-center hover:text-gray-400 font-bold"><Icon name={ChevronLeft} size={18} className="mr-1" strokeWidth={1} /> Back</button>
                            <div className="flex justify-between items-end border-b pb-10 mb-20 border-gray-100">
                                <h2 className="text-xs font-bold uppercase tracking-[0.125em]">Selected List</h2>
                                <p className="text-[10px] text-grey-medium font-bold uppercase tracking-[0.05em]">{cart.length} / {currentLimit}</p>
                            </div>
                            <div className="space-y-16 mb-32">
                                {cart.map((item, i) => (
                                    <div key={i} className="flex space-x-10 items-center group">
                                        <div className="w-28 aspect-[2/3] bg-gray-50 shadow-2xl overflow-hidden">
                                            <img src={item.image} className="w-full h-full object-cover" />
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="text-[12px] font-bold uppercase tracking-[0.075em] mb-3">{item.productName}</h4>
                                            <p className="text-[10px] text-grey-medium tracking-[0.1em] uppercase">Size: <span className="text-black ml-2 font-bold">{item.size}</span></p>
                                        </div>
                                        <button onClick={() => setCart(cart.filter((_, idx) => idx !== i))} className="text-gray-300 hover:text-red-500 transition-all duration-500 p-4"><Icon name={X} size={24} strokeWidth={1}/></button>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-gray-50 p-12 space-y-16 shadow-2xl rounded-sm border border-gray-100">
                                <h3 className="text-[11px] font-bold uppercase tracking-[0.125em] border-b pb-8 border-gray-200">Shipping Information</h3>
                                <div className="space-y-10">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-10">
                                        <input placeholder="INSTAGRAM (@)" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.instagramId} onChange={e => setFormData({...formData, instagramId: e.target.value})} />
                                        <input placeholder="NAME" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-10">
                                        <input placeholder="PHONE" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                                        <input placeholder="ADDRESS" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} />
                                    </div>
                                    <textarea placeholder="MESSAGE" className="w-full h-32 border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none resize-none uppercase" value={formData.message} onChange={e => setFormData({...formData, message: e.target.value})} />
                                    <div className="flex items-center space-x-6 cursor-pointer group py-4 px-2 hover:bg-black/5 transition-colors rounded" onClick={() => setFormData({...formData, agreed: !formData.agreed})}>
                                        <div className="flex-shrink-0 transition-transform active:scale-90">
                                            {formData.agreed ? <Icon name={CheckSquare} size={28} className="text-black" /> : <Icon name={Square} size={28} className="text-black/30 border-2 border-black/10 rounded" />}
                                        </div>
                                        <span className="text-[12px] text-black font-medium leading-relaxed select-none">
                                            *재고 상황 등에 따라 일부 내용이 달라질 수 있으며, 올려주신 콘텐츠는 브랜드 소개나 홍보에 활용될 수 있음에 동의합니다.
                                        </span>
                                    </div>
                                    <button onClick={submit} className="w-full bg-black text-white py-8 text-[11px] tracking-[0.15em] font-bold shadow-2xl disabled:opacity-30 uppercase transition-all" disabled={!cart.length || !formData.agreed}>제출하기</button>
                                </div>
                            </div>
                        </main>
                    )}
                    <SyncMonitor />
                    <Toast error={error} success={success} />
                </div>
            );
        };

        const App = () => {
            const [state, setState] = useState({ collections: [], adminAccessCode: 'admin' });
            const [isLoading, setIsLoading] = useState(true);
            const [view, setView] = useState('login');
            const [currentUser, setCurrentUser] = useState(null);
            const [activeCollection, setActiveCollection] = useState(null);
            const [accessCodeInput, setAccessCodeInput] = useState('');
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [cart, setCart] = useState([]);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [newCollectionName, setNewCollectionName] = useState('');
            const [adminSubView, setAdminSubView] = useState('settings');
            const scrollPosRef = useRef(0);
            
            useEffect(() => {
                const configUnsub = db.collection('config').doc('global').onSnapshot(doc => {
                    if (doc.exists) {
                        setState(s => ({ ...s, adminAccessCode: doc.data().adminAccessCode || 'admin' }));
                    } else {
                        db.collection('config').doc('global').set({ adminAccessCode: 'admin' });
                    }
                });

                const collUnsub = db.collection('collections').onSnapshot(querySnapshot => {
                    const colls = [];
                    querySnapshot.forEach(doc => colls.push({ ...doc.data(), firebaseId: doc.id }));
                    setState(s => ({ ...s, collections: colls }));
                    setIsLoading(false);
                });

                return () => {
                    configUnsub();
                    collUnsub();
                };
            }, []);

            useEffect(() => {
                if (activeCollection) {
                    const latest = state.collections.find(c => c.id === activeCollection.id);
                    if (latest) setActiveCollection(latest);
                }
            }, [state.collections]);
            
            const notify = (msg, type) => { 
                if (type === 'success') { setSuccess(msg); setTimeout(() => setSuccess(null), 3000); } 
                else { setError(msg); setTimeout(() => setError(null), 3000); } 
            };

            const handleLogin = () => {
                const code = accessCodeInput.trim().toLowerCase();
                if (code === state.adminAccessCode.toLowerCase().trim()) { 
                    setCurrentUser('admin'); 
                    setView('select_collection'); 
                } else {
                    const matched = state.collections.find(c => (c.accessCodesV2 || []).some(ac => ac.code && ac.code.toLowerCase().trim() === code));
                    if (matched) { 
                        setActiveCollection(matched); 
                        setCurrentUser('influencer'); 
                        setView('influencer'); 
                    } else {
                        notify('Invalid Access Code', 'error');
                    }
                }
            };

            const handleLogout = () => { setCurrentUser(null); setActiveCollection(null); setView('login'); setAccessCodeInput(''); setCart([]); scrollPosRef.current = 0; };
            
            const createCollection = async (name) => {
                if (!name.trim()) return;
                const newColl = {
                    id: generateId(),
                    name: name.trim(),
                    accessCodesV2: [{ code: generateId().substring(0, 6), limit: 2 }],
                    lookbookImages: [],
                    descriptionTitle: 'New Story',
                    descriptionBody: 'Collection inspiration...',
                    products: [],
                    shippingEntries: []
                };
                try {
                    await db.collection('collections').add(newColl);
                    setIsCreateModalOpen(false);
                    setNewCollectionName('');
                    notify('Collection Created', 'success');
                } catch (err) {
                    notify('Cloud Save Failed', 'error');
                }
            };

            const updateCollection = async (updated) => {
                try {
                    const docId = updated.firebaseId;
                    if (!docId) return;
                    const dataToSave = { ...updated };
                    delete dataToSave.firebaseId;
                    await db.collection('collections').doc(docId).set(dataToSave);
                } catch (err) {
                    notify('Cloud Update Failed', 'error');
                }
            };

            const deleteCollection = async (docId) => {
                try {
                    await db.collection('collections').doc(docId).delete();
                    setView('select_collection');
                    notify('Deleted from Cloud', 'success');
                } catch (err) {
                    notify('Delete Failed', 'error');
                }
            };

            const updateAdminCode = (newCode) => {
                db.collection('config').doc('global').update({ adminAccessCode: newCode });
            };

            if (isLoading) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white space-y-6">
                    <div className="loader w-12 h-12"></div>
                    <span className="text-[10px] tracking-[0.125em] uppercase font-bold animate-pulse">nuuanu cloud initializing</span>
                </div>
            );
            
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-white animate-fade-in"><div className="max-w-md w-full text-center space-y-20"><h1 className="text-6xl font-light tracking-[0.1em] uppercase">nuuanu</h1><div className="space-y-6"><input type="text" placeholder="ACCESS CODE" className="w-full border-b border-gray-200 py-4 text-center focus:outline-none focus:border-black tracking-[0.075em] uppercase text-sm bg-transparent transition-colors" value={accessCodeInput} onChange={e => setAccessCodeInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} autoFocus /><button onClick={handleLogin} className="w-full bg-black text-white py-5 text-[10px] tracking-[0.125em] uppercase font-bold transition-all hover:bg-black/90 active:scale-95">Entrance</button></div></div><Toast error={error} success={success} /></div>
            );

            if (view === 'select_collection') return (
                <div className="min-h-screen bg-white p-10 sm:p-20 animate-fade-in"><div className="max-w-6xl mx-auto space-y-16"><div className="flex justify-between items-end border-b border-gray-100 pb-10"><div><h2 className="text-[10px] tracking-[0.1em] uppercase text-grey-medium mb-2">Management Console</h2><h1 className="text-4xl font-light tracking-normal uppercase">Collections</h1></div><button onClick={handleLogout} className="text-[10px] uppercase tracking-[0.075em] border-b border-black pb-1 hover:text-black hover:border-black transition-colors">Logout</button></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    {state.collections.map(c => (
                        <div key={c.id} className="relative group"><div onClick={() => { setActiveCollection(c); setAdminSubView('settings'); setView('admin'); }} className="border border-gray-100 p-12 hover:border-black transition-all cursor-pointer flex flex-col items-center justify-center space-y-6 aspect-square bg-white shadow-sm hover:shadow-xl"><div className="w-16 h-16 bg-gray-50 flex items-center justify-center rounded-full group-hover:bg-black group-hover:text-white transition-all"><Icon name={Package} size={24}/></div><div className="text-center font-bold tracking-normal uppercase text-xs">{c.name}</div></div><button onClick={(e)=>{e.stopPropagation(); if(confirm(`Delete "${c.name}"?`)) deleteCollection(c.firebaseId); }} className="absolute top-4 right-4 text-red-100 hover:text-red-500 transition-colors"><Icon name={Trash2} size={16}/></button></div>
                    ))}
                    <button onClick={() => setIsCreateModalOpen(true)} className="border border-dashed border-gray-200 p-12 hover:border-black hover:bg-gray-50 flex flex-col items-center justify-center space-y-6 aspect-square group text-gray-300 hover:text-black transition-all"><Icon name={Plus} size={24}/><span className="text-[10px] uppercase font-bold">New Catalog</span></button>
                </div></div>
                {isCreateModalOpen && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 px-6 backdrop-blur-sm" onClick={() => setIsCreateModalOpen(false)}><div className="bg-white p-12 w-full max-w-sm shadow-2xl space-y-12 animate-fade-in" onClick={e => e.stopPropagation()}><h3 className="text-xs font-bold uppercase border-b pb-4 text-center tracking-normal">Create New Seeding Catalog</h3><input autoFocus type="text" placeholder="NAME" className="w-full border-b border-gray-200 py-4 text-center focus:border-black outline-none uppercase text-sm tracking-normal" value={newCollectionName} onChange={e => setNewCollectionName(e.target.value)} onKeyDown={e => e.key === 'Enter' && createCollection(newCollectionName)} /><button onClick={() => createCollection(newCollectionName)} className="w-full bg-black text-white py-5 text-[10px] uppercase font-bold tracking-[0.1em]">Confirm Create</button></div></div>)}<SyncMonitor /><Toast error={error} success={success} /></div>
            );

            if (view === 'admin' && activeCollection) return (<AdminDashboard collection={activeCollection} collections={state.collections} onUpdate={updateCollection} onBack={() => setView('select_collection')} activeSubView={adminSubView} setSubView={setAdminSubView} notify={notify} adminAccessCode={state.adminAccessCode} updateAdminCode={updateAdminCode} error={error} success={success} onDelete={() => { if(confirm(`Irreversibly delete "${activeCollection.name}"?`)) deleteCollection(activeCollection.firebaseId); }} />);
            
            if (view === 'influencer' && activeCollection) return (<InfluencerPage collection={activeCollection} cart={cart} setCart={setCart} onLogout={handleLogout} notify={notify} scrollPosRef={scrollPosRef} onSubmission={entries => updateCollection({ ...activeCollection, shippingEntries: [...activeCollection.shippingEntries, ...entries] })} error={error} success={success} loginCode={accessCodeInput} />);
            
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
