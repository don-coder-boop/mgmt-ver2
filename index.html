<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nuuanu | Seeding Management Tool</title>
    
    <!-- Open Graph / Web Preview Tags -->
    <meta property="og:title" content="Nuuanu Collection">
    <meta property="og:description" content="Private Influencer Showroom">
    <meta property="og:image" content="https://res.cloudinary.com/dlpdanxvi/image/upload/v1768441659/open-graph_private-showroom_jx3q9u.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Nuuanu Collection">
    <meta name="twitter:description" content="Private Influencer Showroom">
    <meta name="twitter:image" content="https://res.cloudinary.com/dlpdanxvi/image/upload/v1768441659/open-graph_private-showroom_jx3q9u.png">

    <!-- External Libraries (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #ffffff;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Luxury Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #000; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            background-color: transparent;
        }
        @media (min-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
                column-gap: 1.5rem;
                row-gap: 3rem;
            }
        }
        
        input, textarea, select {
            border-radius: 0 !important;
            font-family: inherit;
            font-weight: inherit;
        }

        .text-grey-dark { color: #222222; }
        .text-grey-medium { color: #444444; }
        .text-grey-light { color: #666666; }

        .truncate-custom {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Blue Scheme for Report */
        .bg-nuuanu-blue-soft { background-color: #f0f7ff; }
        .text-nuuanu-blue { color: #2563eb; }
        .border-nuuanu-blue-light { border-color: #dbeafe; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useMemo } = React;

        // Custom SVG Icons
        const Icons = {
            ShoppingBag: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
            ),
            LogOut: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>
                </svg>
            ),
            ChevronLeft: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            ),
            ChevronRight: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="m9 18 6-6-6-6"/>
                </svg>
            ),
            ChevronDown: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="m6 9 6 6 6-6"/>
                </svg>
            ),
            ChevronUp: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="m18 15-6-6-6 6"/>
                </svg>
            ),
            Plus: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            ),
            X: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
            ),
            Package: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M16.5 9.4 7.5 4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
                </svg>
            ),
            Trash: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                </svg>
            ),
            Settings: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.72V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.17a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>
                </svg>
            ),
            Truck: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/><path d="M14 18h1"/>
                </svg>
            ),
            Chart: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/>
                </svg>
            ),
            Cloud: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.2-3.9-4.5a7 7 0 1 0-12.2 4.1"/>
                </svg>
            ),
            Alert: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>
                </svg>
            ),
            Copy: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                </svg>
            ),
            Spreadsheet: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/>
                </svg>
            ),
            Upload: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
                </svg>
            ),
            Loading: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" {...props}>
                    <path d="M21 12a9 9 0 1 1-6.21-8.58"/>
                </svg>
            ),
            Success: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
                    <circle cx="12" cy="12" r="10"/><polyline points="9 11 12 14 15 9"/>
                </svg>
            )
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAFWB4h6BLqXMCfDxdkKd_9F5aXOUPfHI0",
            authDomain: "nuuanu-portal.firebaseapp.com",
            projectId: "nuuanu-portal",
            storageBucket: "nuuanu-portal.firebasestorage.app",
            messagingSenderId: "318424850254",
            appId: "1:318424850254:web:5dc3ad479a7e4b264b081f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const CLOUDINARY_CLOUD_NAME = 'dtjkkzj00';
        const CLOUDINARY_UPLOAD_PRESET = 'nuuanu seeding preset';

        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) throw new Error('Upload failed');
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw error;
            }
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; }
                    else if (char === '"') inQuotes = false;
                    else currentField += char;
                } else {
                    if (char === '"') inQuotes = true;
                    else if (char === ',') { currentRow.push(currentField); currentField = ''; }
                    else if (char === '\n' || char === '\r') {
                        if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); currentRow = []; currentField = ''; }
                        if (char === '\r' && nextChar === '\n') i++;
                    } else currentField += char;
                }
            }
            if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); }
            return rows;
        };

        const downloadCSV = (filename, data) => {
            if (data.length === 0) return;
            const headers = ["instagram ID", "이름", "전화번호", "받는분기타연락처", "받는분우편번호", "주소", "제품명", "사이즈", "수량", "배송메세지1"];
            const csvRows = [headers.join(',')];
            data.forEach(item => {
                const escape = (val) => `"${String(val || "").replace(/"/g, '""')}"`;
                csvRows.push([
                    escape(item.instagramId), escape(item.name), escape(item.phone),
                    escape(""), escape(""), escape(item.address),
                    escape(item.productName), escape(item.size), escape(1), escape(item.message)
                ].join(','));
            });
            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        const Toast = ({ error, success }) => {
            if (error) return (
                <div className="fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-3 text-[10px] tracking-[0.1em] uppercase font-bold z-[1000] shadow-xl">
                    {error}
                </div>
            );
            if (success) return (
                <div className="fixed top-0 left-0 right-0 bg-black text-white text-center py-3 text-[10px] tracking-[0.1em] uppercase z-[1000] shadow-xl">
                    {success}
                </div>
            );
            return null;
        };

        const SyncMonitor = () => (
            <div className="fixed bottom-6 right-6 bg-white border border-gray-100 p-4 shadow-2xl z-50 min-w-[180px] animate-fade-in flex items-center space-x-3">
                <div className="flex-shrink-0">
                    <Icons.Cloud size={18} className="text-green-500" />
                </div>
                <div className="flex flex-col">
                    <span className="text-[9px] tracking-[0.075em] text-grey-medium uppercase font-bold">Cloud Sync</span>
                    <span className="text-[8px] text-green-600 uppercase font-medium">Real-time Connected</span>
                </div>
            </div>
        );

        const AdminDashboard = ({ collection, collections, onUpdate, onBack, activeSubView, setSubView, notify, adminAccessCode, updateAdminCode, onDelete, error, success }) => {
            const [selectedRows, setSelectedRows] = useState(new Set());
            const [sortConfig, setSortConfig] = useState({ key: 'submitDate', direction: 'desc' });
            const [isUploading, setIsUploading] = useState(false);

            const handleUpdate = (u, skipNotify = false) => { 
                onUpdate({ ...collection, ...u }); 
                if (!skipNotify) notify('Cloud Sync Saved', 'success'); 
            };

            const isCodeGloballyUnique = (code, currentCollectionId, codesInThisCollection = []) => {
                if (!code || code.trim() === '') return true;
                const lowerCode = code.toLowerCase().trim();
                if (lowerCode === adminAccessCode.toLowerCase().trim()) return false;
                const existsInOtherCollection = collections.some(c => {
                    if (c.id === currentCollectionId) return false;
                    const codes = c.accessCodesV2 || [];
                    return codes.some(ac => ac.code.toLowerCase().trim() === lowerCode);
                });
                if (existsInOtherCollection) return false;
                const localMatches = codesInThisCollection.filter(ac => ac.code.toLowerCase().trim() === lowerCode);
                if (localMatches.length > 1) return false;
                return true;
            };

            const handleCodeBulkUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const content = evt.target.result;
                    const rows = parseCSV(content);
                    if (rows.length < 2) return;
                    const newCodes = [];
                    const currentCodes = collection.accessCodesV2 || [];
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (!cols || cols.length < 1) continue;
                        const code = cols[0]?.trim();
                        const limit = cols[1];
                        if (code) {
                            const combinedTemp = [...currentCodes, ...newCodes];
                            if (isCodeGloballyUnique(code, collection.id, [...combinedTemp, { code }])) {
                                newCodes.push({ code: code, limit: parseInt(limit) || 2 });
                            }
                        }
                    }
                    if (newCodes.length > 0) {
                        handleUpdate({ accessCodesV2: [...currentCodes, ...newCodes] });
                        notify(`${newCodes.length} codes imported`, 'success');
                    } else {
                        notify('No valid or unique codes found', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const content = evt.target.result;
                    const rows = parseCSV(content);
                    if (rows.length < 2) return;
                    const newProducts = [];
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (!cols || cols.length < 4) continue;
                        const [name, price, optionStr, summary] = cols;
                        let options = ['OS'];
                        const match = (optionStr || '').match(/size\{([^}]+)\}/i);
                        if (match) options = match[1].split('|');
                        newProducts.push({ id: generateId(), name: name || 'New Item', price: price || '0', options: options, description: summary || '', images: [] });
                    }
                    if (newProducts.length > 0) {
                        handleUpdate({ products: [...collection.products, ...newProducts] });
                        notify(`${newProducts.length} items added`, 'success');
                    }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const shippingEntries = collection.shippingEntries || [];

            const sortedShipping = useMemo(() => {
                const data = [...shippingEntries];
                if (!sortConfig.key) return data;
                return data.sort((a, b) => {
                    const valA = String(a[sortConfig.key] || '').toLowerCase();
                    const valB = String(b[sortConfig.key] || '').toLowerCase();
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [shippingEntries, sortConfig]);

            const handleBulkStatusChange = (newStatus) => {
                if (selectedRows.size === 0) return;
                const next = shippingEntries.map(e => selectedRows.has(e.id) ? { ...e, status: newStatus } : e);
                handleUpdate({ shippingEntries: next });
                setSelectedRows(new Set());
            };

            const toggleRow = (id) => {
                const next = new Set(selectedRows);
                if (next.has(id)) next.delete(id); else next.add(id);
                setSelectedRows(next);
            };

            const toggleAll = () => {
                if (selectedRows.size === sortedShipping.length && sortedShipping.length > 0) setSelectedRows(new Set());
                else setSelectedRows(new Set(sortedShipping.map(e => e.id)));
            };

            const handleSort = (key) => {
                setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
            };

            const renderSortIcon = (key) => {
                if (sortConfig.key !== key) return <Icons.ChevronDown size={14} className="opacity-30 ml-1" />;
                return sortConfig.direction === 'asc' ? <Icons.ChevronUp size={14} className="ml-1" /> : <Icons.ChevronDown size={14} className="ml-1" />;
            };

            const truncateText = (text, len = 10) => {
                if (!text) return '';
                if (text.length <= len) return text;
                return text.substring(0, len) + '...';
            };

            const handleExport = () => {
                const dataToExport = selectedRows.size > 0 
                    ? shippingEntries.filter(e => selectedRows.has(e.id))
                    : shippingEntries;
                downloadCSV(`${collection.name}_shipments.csv`, dataToExport);
            };

            const handleCopyRow = (e) => {
                const newRow = { 
                    ...e, 
                    id: generateId(), 
                    submitDate: new Date().toISOString().split('T')[0], 
                    status: '준비중',
                    isManual: true 
                };
                handleUpdate({ shippingEntries: [newRow, ...shippingEntries] });
            };

            const handleDeleteRow = (id) => {
                if(confirm('Delete this record?')) {
                    handleUpdate({ shippingEntries: shippingEntries.filter(x => x.id !== id) });
                }
            };

            const handleDeleteCollection = () => {
                if (window.confirm("정말로 이 컬렉션을 삭제하시겠습니까? 삭제된 데이터는 복구할 수 없습니다.")) {
                    const inputCode = window.prompt("보안을 위해 어드민 코드를 입력해 주세요.");
                    if (inputCode === adminAccessCode) {
                        onDelete(); // Prop which triggers App.tsx deleteCollection
                    } else if (inputCode !== null) {
                        notify('어드민 코드가 틀렸습니다.', 'error');
                    }
                }
            };

            const handleLookbookUpload = async (e) => {
                if (!e.target.files) return;
                setIsUploading(true);
                try {
                    const uploads = Array.from(e.target.files).map(f => uploadToCloudinary(f));
                    const urls = await Promise.all(uploads);
                    handleUpdate({ lookbookImages: [...(collection.lookbookImages || []), ...urls] });
                    notify(`${urls.length} images uploaded`, 'success');
                } catch (err) {
                    notify('Upload failed.', 'error');
                } finally {
                    setIsUploading(false);
                }
            };

            const handleProductImageUpload = async (productId, e) => {
                if (!e.target.files) return;
                setIsUploading(true);
                try {
                    const uploads = Array.from(e.target.files).map(f => uploadToCloudinary(f));
                    const urls = await Promise.all(uploads);
                    const updatedProducts = (collection.products || []).map(p => 
                        p.id === productId ? { ...p, images: [...(p.images || []), ...urls] } : p
                    );
                    handleUpdate({ products: updatedProducts });
                    notify(`${urls.length} images uploaded`, 'success');
                } catch (err) {
                    notify('Upload failed.', 'error');
                } finally {
                    setIsUploading(false);
                }
            };

            const accessCodes = collection.accessCodesV2 || [];

            const productCounts = useMemo(() => {
                const map = shippingEntries.reduce((acc, curr) => {
                    if (!curr.productName) return acc;
                    const n = curr.productName.toUpperCase().trim();
                    acc[n] = (acc[n] || 0) + 1;
                    return acc;
                }, {});
                return Object.entries(map).sort((a, b) => b[1] - a[1]);
            }, [shippingEntries]);

            const maxCount = useMemo(() => {
                return productCounts.length > 0 ? productCounts[0][1] : 0;
            }, [productCounts]);

            return (
                <div className="min-h-screen bg-white flex flex-col animate-fade-in">
                    <header className="border-b border-gray-100 py-8 px-12 flex justify-between items-center bg-white sticky top-0 z-40 backdrop-blur-md bg-white/90">
                        <div className="flex items-center space-x-12">
                            <button onClick={onBack} className="text-[15px] uppercase tracking-[0.075em] flex items-center hover:text-gray-400 font-bold group">
                                <Icons.ChevronLeft size={22} className="mr-2 group-hover:-translate-x-1 transition-transform" /> Back
                            </button>
                            <h2 className="text-[18px] font-bold tracking-[0.1em] uppercase">{collection.name}</h2>
                        </div>
                        <nav className="flex space-x-16">
                            {[
                                {id:'settings', label:'Settings', icon:Icons.Settings}, 
                                {id:'products', label:'Products', icon:Icons.Package}, 
                                {id:'shipping', label:'Shipping', icon:Icons.Truck}, 
                                {id:'report', label:'Report', icon:Icons.Chart}
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setSubView(tab.id)} className={`flex items-center space-x-3 text-[15px] uppercase tracking-[0.075em] py-2 ${activeSubView === tab.id ? 'text-black font-bold border-b-2 border-black' : 'text-grey-medium hover:text-black'}`}>
                                    <tab.icon size={20} /> <span className="hidden md:inline">{tab.label}</span>
                                </button>
                            ))}
                        </nav>
                    </header>
                    <main className="flex-1 p-12 overflow-auto">
                        {isUploading && (
                            <div className="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black text-white px-8 py-4 flex items-center space-x-4 shadow-2xl">
                                <Icons.Loading className="animate-spin" />
                                <span className="text-[12px] font-bold uppercase tracking-normal">Syncing...</span>
                            </div>
                        )}
                        {activeSubView === 'settings' && (
                            <div className="max-w-5xl mx-auto space-y-20 py-10">
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Global Config</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                                        <div className="space-y-4">
                                            <label className="text-[14px] text-grey-medium uppercase font-bold tracking-normal">Admin Code</label>
                                            <input type="text" className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" value={adminAccessCode} onChange={e => updateAdminCode(e.target.value)} />
                                        </div>
                                    </div>
                                </section>
                                <section className="space-y-10">
                                    <div className="flex justify-between items-center border-b pb-6">
                                        <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Influencer Access Codes</h3>
                                        <div className="flex space-x-4">
                                            <label className="text-[14px] uppercase font-bold text-black border-2 border-black px-6 py-2 flex items-center cursor-pointer hover:bg-black hover:text-white transition-colors">
                                                <Icons.Spreadsheet size={18} className="mr-2"/> Bulk Upload
                                                <input type="file" accept=".csv" className="hidden" onChange={handleCodeBulkUpload} />
                                            </label>
                                            <button onClick={() => {
                                                const newCode = { code: generateId().substring(0,6), limit: 2 };
                                                handleUpdate({ accessCodesV2: [...accessCodes, newCode] });
                                            }} className="text-[14px] uppercase font-bold text-white bg-black px-6 py-2 flex items-center"><Icons.Plus size={18} className="mr-2"/> Add Code</button>
                                        </div>
                                    </div>
                                    <div className="grid gap-8">
                                        {accessCodes.map((ac, idx) => {
                                            const isUnique = isCodeGloballyUnique(ac.code, collection.id, accessCodes);
                                            return (
                                                <div key={idx} className={`flex flex-col sm:flex-row items-center gap-10 p-8 border transition-colors ${!isUnique ? 'border-red-500 bg-red-50' : 'bg-gray-50/30'}`}>
                                                    <div className="flex-1 space-y-4 w-full">
                                                        <label className="text-[12px] text-grey-light uppercase tracking-normal font-bold">Code</label>
                                                        <div className="relative">
                                                            <input type="text" className={`w-full bg-white border-b-2 py-3 px-3 outline-none text-[16px] uppercase transition-colors ${!isUnique ? 'border-red-500 focus:border-red-600' : 'focus:border-black'}`} value={ac.code} onChange={e => {
                                                                const codes = [...accessCodes];
                                                                codes[idx].code = e.target.value.trim();
                                                                handleUpdate({ accessCodesV2: codes }, true);
                                                            }} />
                                                            {!isUnique && <div className="mt-2 text-[10px] text-red-600 font-bold uppercase tracking-tight flex items-center"><Icons.Alert size={14} className="mr-1"/> 이미 사용 중인 코드입니다.</div>}
                                                        </div>
                                                    </div>
                                                    <div className="w-full sm:w-40 space-y-4">
                                                        <label className="text-[12px] text-grey-light uppercase tracking-normal font-bold">Limit</label>
                                                        <input type="number" className="w-full bg-white border-b-2 py-3 px-3 focus:border-black outline-none text-[16px]" value={ac.limit} onChange={e => {
                                                            const codes = [...accessCodes];
                                                            codes[idx].limit = parseInt(e.target.value) || 1;
                                                            handleUpdate({ accessCodesV2: codes }, true);
                                                        }} />
                                                    </div>
                                                    <button onClick={() => handleUpdate({ accessCodesV2: accessCodes.filter((_, i) => i !== idx) })} className="p-3 bg-black text-white hover:bg-black/80 transition-colors rounded"><Icons.Trash size={20}/></button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Collection Details</h3>
                                    <input placeholder="TITLE" className="w-full text-5xl font-light tracking-normal border-b-2 py-6 outline-none focus:border-black uppercase" value={collection.descriptionTitle} onChange={e => handleUpdate({ descriptionTitle: e.target.value }, true)} />
                                    <textarea placeholder="STORY CONTENT" className="w-full h-64 border-2 p-10 text-[16px] font-light outline-none focus:border-black leading-relaxed" value={collection.descriptionBody} onChange={e => handleUpdate({ descriptionBody: e.target.value }, true)} />
                                </section>
                                <section className="space-y-10">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em] border-b pb-6">Lookbook</h3>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 lg:gap-0">
                                        {(collection.lookbookImages || []).map((img, i) => (
                                            <div key={i} className="relative group bg-transparent border overflow-hidden">
                                                <img src={img} className="w-full h-auto block" />
                                                <button onClick={() => { const next = [...collection.lookbookImages]; next.splice(i, 1); handleUpdate({ lookbookImages: next }); }} className="absolute top-4 right-4 bg-white/80 p-3 opacity-0 group-hover:opacity-100 shadow transition-opacity z-10"><Icons.X size={20}/></button>
                                            </div>
                                        ))}
                                        <label className={`aspect-[1/1.5] border-2 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-black transition-all group ${isUploading ? 'opacity-50 pointer-events-none' : ''}`}>
                                            <Icons.Upload size={32} className={`text-gray-200 group-hover:text-black ${isUploading ? 'animate-spin' : ''}`} />
                                            <input type="file" multiple className="hidden" onChange={handleLookbookUpload} />
                                        </label>
                                    </div>
                                </section>
                                <div className="pt-24 text-center">
                                    <button 
                                        onClick={handleDeleteCollection} 
                                        className="text-red-400 text-[14px] uppercase font-bold px-16 py-5 bg-red-50 rounded-full hover:bg-red-100 transition-colors"
                                    >
                                        Delete Collection
                                    </button>
                                </div>
                            </div>
                        )}
                        {activeSubView === 'products' && (
                            <div className="max-w-6xl mx-auto space-y-16">
                                <div className="flex justify-between items-end border-b pb-8">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Catalog</h3>
                                    <div className="flex space-x-6">
                                        <label className="bg-white border-2 border-black text-black px-10 py-4 text-[14px] uppercase font-bold cursor-pointer hover:bg-black hover:text-white transition-all flex items-center">
                                            <Icons.Spreadsheet size={20} className="mr-3" /> Bulk Upload
                                            <input type="file" accept=".csv" className="hidden" onChange={handleCSVUpload} />
                                        </label>
                                        <button onClick={() => handleUpdate({ products: [...(collection.products || []), { id: generateId(), name: 'New Item', price: '0', options: ['OS'], description: '', images: [] }] })} className="bg-black text-white px-12 py-4 text-[14px] uppercase font-bold flex items-center"><Icons.Plus size={20} className="mr-3" /> Add Product</button>
                                    </div>
                                </div>
                                <div className="grid gap-16">
                                    {(collection.products || []).map(p => (
                                        <div key={p.id} className="border-2 p-12 flex flex-col xl:flex-row gap-16 bg-white hover:shadow-2xl transition-all">
                                            <div className="flex-1 grid gap-12 md:grid-cols-2">
                                                <div className="space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Name</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[18px] font-bold" value={p.name} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, name: e.target.value} : x) }, true)} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Price</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" value={p.price} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, price: e.target.value} : x) }, true)} />
                                                </div>
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Sizes</label>
                                                    <input className="w-full border-b-2 py-3 focus:border-black outline-none text-[16px]" placeholder="e.g. 1, 2, 3" value={p.options.join(',')} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, options: e.target.value.split(',')} : x) }, true)} />
                                                </div>
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-[12px] uppercase font-bold text-grey-light">Summary</label>
                                                    <textarea className="w-full h-48 border-2 p-6 focus:border-black outline-none text-[16px] leading-relaxed" placeholder="Product Details" value={p.description} onChange={e => handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, description: e.target.value} : x) }, true)} />
                                                </div>
                                            </div>
                                            <div className="xl:w-80 space-y-8">
                                                <div className="grid grid-cols-3 gap-3">
                                                    {(p.images || []).map((img, i) => (
                                                        <div key={i} className="aspect-[2/3] relative group border overflow-hidden bg-transparent">
                                                          <img src={img} className="absolute inset-0 w-full h-full object-cover block"/>
                                                          <button onClick={() => { const ni = [...p.images]; ni.splice(i, 1); handleUpdate({ products: collection.products.map(x => x.id === p.id ? {...x, images: ni} : x) }); }} className="absolute top-2 right-2 bg-white p-2 opacity-0 group-hover:opacity-100 shadow transition-opacity z-10"><Icons.X size={14}/></button>
                                                        </div>
                                                    ))}
                                                    <label className={`aspect-[2/3] border-2 border-dashed flex items-center justify-center cursor-pointer hover:border-black transition-colors ${isUploading ? 'opacity-50 pointer-events-none' : ''}`}>
                                                        <Icons.Plus size={24} className={isUploading ? 'animate-spin' : ''} />
                                                        <input type="file" multiple className="hidden" onChange={(e) => handleProductImageUpload(p.id, e)} />
                                                    </label>
                                                </div>
                                                <button onClick={() => { if(confirm('Remove this product?')) handleUpdate({ products: collection.products.filter(x => x.id !== p.id) }); }} className="text-red-500 text-[14px] uppercase font-bold w-full pt-6 border-t-2 border-dashed">Remove Item</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeSubView === 'shipping' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="flex justify-between items-center border-b pb-8">
                                    <h3 className="text-[15px] font-bold uppercase tracking-[0.1em]">Tracking Table</h3>
                                    <div className="flex space-x-6 items-center">
                                        {selectedRows.size > 0 && (
                                            <div className="flex space-x-3 bg-gray-50 p-3 rounded items-center">
                                                <span className="text-[14px] uppercase font-bold text-grey-medium px-4">{selectedRows.size} selected</span>
                                                <button onClick={() => handleBulkStatusChange('배송완료')} className="text-[14px] font-bold uppercase bg-black text-white px-6 py-3 transition-colors hover:bg-black/90">Set Delivered</button>
                                                <button onClick={() => handleBulkStatusChange('준비중')} className="text-[14px] font-bold uppercase border-2 border-black px-6 py-3 transition-colors hover:bg-black hover:text-white">Set Preparing</button>
                                            </div>
                                        )}
                                        <button onClick={handleExport} className="text-[14px] font-bold uppercase border-2 border-black px-10 py-3 hover:bg-black hover:text-white transition-all">
                                            {selectedRows.size > 0 ? `Export ${selectedRows.size} Selected` : 'Export All CSV'}
                                        </button>
                                    </div>
                                </div>
                                {shippingEntries.length === 0 ? (
                                    <div className="py-24 text-center text-grey-medium uppercase tracking-[0.1em] text-xs">주문 내역이 없습니다.</div>
                                ) : (
                                    <div className="overflow-x-auto border-2">
                                        <table className="w-full text-left text-[16px] min-w-[1400px]">
                                            <thead className="bg-gray-50 uppercase text-[12px] tracking-[0.05em] text-grey-medium border-b-2 sticky top-0 z-10">
                                                <tr>
                                                    <th className="p-6 w-16 text-center">
                                                        <input type="checkbox" className="w-4 h-4" checked={selectedRows.size === sortedShipping.length && sortedShipping.length > 0} onChange={toggleAll} />
                                                    </th>
                                                    {[
                                                        { key: 'status', label: 'Status' },
                                                        { key: 'submitDate', label: 'Date' },
                                                        { key: 'instagramId', label: 'Insta ID' },
                                                        { key: 'name', label: 'Name' },
                                                        { key: 'phone', label: 'Phone' },
                                                        { key: 'address', label: 'Address' },
                                                        { key: 'productName', label: 'Product' },
                                                        { key: 'size', label: 'Size' },
                                                        { key: 'adminMemo', label: 'Memo' }
                                                    ].map(col => (
                                                        <th key={col.key} className={`p-6 cursor-pointer hover:text-black group select-none whitespace-nowrap`} onClick={() => handleSort(col.key)}>
                                                            <div className="flex items-center">
                                                                {col.label} {renderSortIcon(col.key)}
                                                            </div>
                                                        </th>
                                                    ))}
                                                    <th className="p-6 text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y-2 divide-gray-100">
                                                {sortedShipping.map(e => (
                                                    <tr key={e.id} className={`${selectedRows.has(e.id) ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-50/50 transition-colors`}>
                                                        <td className="p-6 text-center">
                                                            <input type="checkbox" className="w-4 h-4" checked={selectedRows.has(e.id)} onChange={() => toggleRow(e.id)} />
                                                        </td>
                                                        <td className="p-6">
                                                            <select className={`text-[12px] px-3 py-2 border-2 font-bold uppercase bg-white ${e.status === '배송완료' ? 'text-green-600 border-green-100 bg-green-50' : 'text-orange-600 border-orange-100 bg-orange-50'}`} value={e.status} onChange={val => handleUpdate({ shippingEntries: shippingEntries.map(x => x.id === e.id ? {...x, status: val.target.value} : x) })}>
                                                                <option value="준비중">준비중</option>
                                                                <option value="배송완료">배송완료</option>
                                                            </select>
                                                        </td>
                                                        <td className="p-6 text-grey-medium font-mono text-[14px]">{e.submitDate}</td>
                                                        <td className="p-6 font-bold uppercase">@{e.instagramId}</td>
                                                        <td className="p-6">{e.name}</td>
                                                        <td className="p-6 truncate-custom">{truncateText(e.phone, 13)}</td>
                                                        <td className="p-6 truncate-custom" title={e.address}>{truncateText(e.address, 20)}</td>
                                                        <td className="p-6">
                                                            <input className="w-full bg-transparent border-b-2 border-transparent focus:border-black outline-none" value={e.productName} onChange={v => handleUpdate({ shippingEntries: shippingEntries.map(x => x.id === e.id ? {...x, productName: v.target.value} : x) }, true)} />
                                                        </td>
                                                        <td className="p-6">
                                                            <input className="w-full bg-transparent border-b-2 border-transparent focus:border-black outline-none uppercase" value={e.size} onChange={v => handleUpdate({ shippingEntries: shippingEntries.map(x => x.id === e.id ? {...x, size: v.target.value} : x) }, true)} />
                                                        </td>
                                                        <td className="p-6">
                                                            <textarea className="w-full h-12 text-[14px] border-2 bg-transparent p-2 focus:bg-white focus:h-24 transition-all outline-none" placeholder="..." value={e.adminMemo || ''} onChange={v => handleUpdate({ shippingEntries: shippingEntries.map(x => x.id === e.id ? {...x, adminMemo: v.target.value} : x) }, true)} />
                                                        </td>
                                                        <td className="p-6 text-right">
                                                            <div className="flex justify-end space-x-3">
                                                                <button onClick={() => handleCopyRow(e)} className="p-2 bg-black text-white hover:bg-black/80 transition-transform rounded flex items-center justify-center" title="Copy Row"><Icons.Copy size={18}/></button>
                                                                {e.isManual && (
                                                                    <button onClick={() => handleDeleteRow(e.id)} className="p-2 bg-black text-white hover:bg-red-600 transition-transform rounded flex items-center justify-center" title="Delete Row"><Icons.Trash size={18}/></button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                        {activeSubView === 'report' && (
                            <div className="max-w-6xl mx-auto space-y-20 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                                    <div className="bg-nuuanu-blue-soft p-12 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[11px] text-nuuanu-blue uppercase font-bold tracking-wider">Total Items</p>
                                        <p className="text-6xl font-light text-nuuanu-blue">{shippingEntries.length}</p>
                                    </div>
                                    <div className="bg-nuuanu-blue-soft p-12 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[11px] text-nuuanu-blue uppercase font-bold tracking-wider">Unique Influencers</p>
                                        <p className="text-6xl font-light text-nuuanu-blue">{new Set(shippingEntries.map(s => s.instagramId)).size}</p>
                                    </div>
                                    <div className="bg-nuuanu-blue-soft p-12 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[11px] text-nuuanu-blue uppercase font-bold tracking-wider">Unused Codes</p>
                                        <p className="text-6xl font-light text-nuuanu-blue">
                                            {Math.max(0, accessCodes.length - new Set(shippingEntries.map(s => s.usedCode).filter(Boolean)).size)}
                                        </p>
                                    </div>
                                    <div className="bg-nuuanu-blue-soft p-12 border-2 border-nuuanu-blue-light shadow-sm text-center space-y-4 rounded-xl">
                                        <p className="text-[11px] text-nuuanu-blue uppercase font-bold tracking-wider">Completion</p>
                                        <p className="text-6xl font-light text-nuuanu-blue">{shippingEntries.length ? Math.round((shippingEntries.filter(s => s.status === '배송완료').length / shippingEntries.length) * 100) : 0}%</p>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-12 border-2 shadow-sm rounded-xl">
                                    <h3 className="text-[15px] font-bold uppercase mb-12 border-b-2 pb-6 tracking-wider">Product Popularity</h3>
                                    {productCounts.length === 0 ? (
                                        <div className="py-24 text-center text-grey-medium uppercase text-xs">표시할 데이터가 없습니다.</div>
                                    ) : (
                                        <div className="space-y-6">
                                            {productCounts.map(([name, count]) => (
                                                <div key={name} className="flex items-center space-x-6">
                                                    <div className="w-1/4 text-[12px] font-bold uppercase truncate text-grey-medium" title={name}>{name}</div>
                                                    <div className="flex-1 relative h-8 bg-gray-50 rounded-full overflow-hidden">
                                                        <div 
                                                            className="absolute top-0 left-0 h-full bg-nuuanu-blue transition-all duration-1000 ease-out"
                                                            style={{ width: `${(count / maxCount) * 100}%` }}
                                                        />
                                                    </div>
                                                    <div className="w-12 text-[12px] font-bold text-nuuanu-blue">{count}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                    <SyncMonitor />
                    <Toast error={error} success={success} />
                </div>
            );
        };

        const InfluencerPage = ({ collection, cart, setCart, onLogout, notify, onSubmission, scrollPosRef, error, success, loginCode }) => {
            const [view, setView] = useState('lookbook');
            const [activeSlide, setActiveSlide] = useState(0);
            const [selectedProd, setSelectedProd] = useState(null);
            const [selectedSize, setSelectedSize] = useState('');
            const [formData, setFormData] = useState({ instagramId: '', name: '', phone: '', address: '', message: '', extra: '', agreed: false });
            
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const minSwipeDistance = 50;

            const currentLimit = useMemo(() => {
                const acs = (collection && collection.accessCodesV2) || [];
                const found = acs.find(a => a.code && a.code.toLowerCase().trim() === loginCode.toLowerCase().trim());
                return found ? found.limit : 1;
            }, [collection, loginCode]);

            useLayoutEffect(() => { 
                if (view === 'lookbook' && scrollPosRef.current > 0) setTimeout(() => window.scrollTo({ top: scrollPosRef.current, behavior: 'instant' }), 0); 
            }, [view]);

            const handleNav = (v) => { 
                if (view === 'lookbook') scrollPosRef.current = window.scrollY; 
                setView(v); window.scrollTo(0, 0); 
            };

            const next = () => { 
                if(!(collection.lookbookImages?.length)) return; 
                setActiveSlide(p => (p + 2) >= collection.lookbookImages.length ? 0 : p + 2); 
            };
            const prev = () => { 
                if(!(collection.lookbookImages?.length)) return; 
                setActiveSlide(p => p - 2 < 0 ? Math.max(0, collection.lookbookImages.length - (collection.lookbookImages.length % 2 || 2)) : p - 2); 
            };
            
            const handleTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };

            const handleTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            const handleTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                if (isLeftSwipe) next();
                if (isRightSwipe) prev();
            };

            const addToCart = () => { 
                if(!selectedProd || !selectedSize) { alert('Select size preference'); return; } 
                if(cart.length >= currentLimit) { alert(`Selection limit reached: ${currentLimit} items.`); return; } 
                setCart([...cart, { id: generateId(), productName: selectedProd.name, size: selectedSize, image: (selectedProd.images && selectedProd.images[0]) || 'https://picsum.photos/400/600' }]); 
                notify('Added to selection', 'success'); 
                handleNav('lookbook'); 
            };

            const submit = () => { 
                if(!formData.instagramId || !formData.name || !formData.phone || !formData.address || !formData.agreed) { alert('Check required fields'); return; } 
                onSubmission(cart.map(item => ({ 
                    id: generateId(), 
                    status: '준비중', 
                    submitDate: new Date().toISOString().split('T')[0], 
                    ...formData, 
                    productName: item.productName, 
                    size: item.size, 
                    quantity: 1, 
                    usedCode: loginCode, 
                    adminMemo: '',
                    isManual: false 
                }))); 
                setView('success'); setCart([]); 
            };

            if (view === 'success') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-12 text-center space-y-12 animate-fade-in">
                    <Icons.Success size={80} strokeWidth={1}/>
                    <h2 className="text-2xl font-light tracking-[0.1em] uppercase">Complete</h2>
                    <p className="text-sm font-light text-grey-medium max-w-sm">Thank you, nuuanu girl! We love having you as part of our journey✨</p>
                    <button onClick={onLogout} className="text-[10px] tracking-[0.125em] border-b border-black pb-1 uppercase font-bold">Sign Out</button>
                </div>
            );

            return (
                <div className="min-h-screen bg-white pb-40 animate-fade-in">
                    <header className="px-10 py-10 sticky top-0 bg-white/95 backdrop-blur-md z-40 flex justify-between items-center border-b border-gray-50">
                        <h1 className="text-2xl font-light tracking-[0.125em] uppercase cursor-pointer" onClick={() => handleNav('lookbook')}>nuuanu</h1>
                        <div className="flex items-center space-x-4">
                            <button onClick={() => handleNav('cart')} className="relative flex items-center transition-transform active:scale-90 p-1">
                                <Icons.ShoppingBag size={28} />
                                {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-black text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold">{cart.length}</span>}
                            </button>
                            <button onClick={onLogout} className="flex items-center transition-transform active:scale-90 p-1 text-grey-medium hover:text-black">
                                <Icons.LogOut size={26} />
                            </button>
                        </div>
                    </header>
                    {view === 'lookbook' && (
                        <main className="animate-fade-in">
                            <section 
                                className="relative px-0 py-10 overflow-hidden"
                                onTouchStart={handleTouchStart}
                                onTouchMove={handleTouchMove}
                                onTouchEnd={handleTouchEnd}
                            >
                                <div className="grid grid-cols-1 md:grid-cols-2 max-w-7xl mx-auto relative group">
                                    {(collection.lookbookImages && collection.lookbookImages.length > 0) ? (
                                        <>
                                            <div className="aspect-[2/3] bg-transparent overflow-hidden relative">
                                                <img src={collection.lookbookImages[activeSlide]} className="w-full h-full object-cover block" />
                                            </div>
                                            <div className="hidden md:block aspect-[2/3] bg-transparent overflow-hidden relative">
                                                <img src={collection.lookbookImages[activeSlide+1] || collection.lookbookImages[0]} className="w-full h-full object-cover block" />
                                            </div>
                                        </>
                                    ) : (
                                        <div className="col-span-2 aspect-[2/1.5] bg-transparent flex items-center justify-center text-[10px] tracking-[0.1em] text-grey-medium uppercase">Lookbook coming soon</div>
                                    )}

                                    {collection.lookbookImages && collection.lookbookImages.length > 2 && (
                                        <>
                                            <button 
                                                onClick={prev} 
                                                className="absolute left-4 top-1/2 -translate-y-1/2 z-30 p-4 bg-white/10 hover:bg-white/30 backdrop-blur-sm rounded-full transition-all text-white drop-shadow-lg hidden md:flex items-center justify-center"
                                            >
                                                <Icons.ChevronLeft size={36} strokeWidth={2} />
                                            </button>
                                            <button 
                                                onClick={next} 
                                                className="absolute right-4 top-1/2 -translate-y-1/2 z-30 p-4 bg-white/10 hover:bg-white/30 backdrop-blur-sm rounded-full transition-all text-white drop-shadow-lg hidden md:flex items-center justify-center"
                                            >
                                                <Icons.ChevronRight size={36} strokeWidth={2} />
                                            </button>
                                        </>
                                    )}
                                </div>
                            </section>
                            <section className="max-w-2xl mx-auto text-center mt-6 mb-32 px-10 space-y-6">
                                <h2 className="text-2xl font-light tracking-[0.125em] uppercase border-b border-gray-100 pb-4 inline-block">{collection.descriptionTitle}</h2>
                                <div className="text-sm font-light leading-relaxed tracking-[0.05em] text-grey-dark" dangerouslySetInnerHTML={{ __html: (collection.descriptionBody || '').replace(/\n/g, '<br/>') }} />
                            </section>
                            <section className="max-w-6xl mx-auto px-10">
                                <div className="flex justify-between items-end border-b border-gray-50 pb-5 mb-10">
                                    <div><h3 className="text-[12px] font-bold uppercase tracking-[0.125em]">Selection</h3></div>
                                    <p className="text-[10px] text-grey-medium uppercase tracking-[0.1em] font-bold">Limit: {cart.length} / {currentLimit}</p>
                                </div>
                                <div className="product-grid">
                                    {(collection.products || []).map(p => (
                                        <div key={p.id} className="group cursor-pointer" onClick={() => { setSelectedProd(p); handleNav('product_detail'); }}>
                                            <div className="mb-2 overflow-hidden relative bg-transparent">
                                                <img src={(p.images && p.images[0]) || 'https://picsum.photos/seed/nuuanu/400/600'} className="w-full aspect-[3/4] object-cover group-hover:scale-110 transition-transform duration-[2000ms]" />
                                            </div>
                                            <div className="space-y-1">
                                                <h4 className="text-[12px] font-normal tracking-normal uppercase">{p.name}</h4>
                                                <p className="text-[10px] text-grey-medium uppercase">KRW {p.price}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        </main>
                    )}
                    {view === 'product_detail' && selectedProd && (
                        <main className="max-w-6xl mx-auto px-10 pt-16 animate-fade-in">
                            <button onClick={() => handleNav('lookbook')} className="text-[11px] tracking-[0.1em] uppercase mb-24 flex items-center hover:text-gray-400 font-bold">
                                <Icons.ChevronLeft size={18} className="mr-1" /> Back
                            </button>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-32">
                                <div className="space-y-10">
                                    <div className="bg-transparent shadow-2xl overflow-hidden relative">
                                        <img src={(selectedProd.images && selectedProd.images[0]) || 'https://picsum.photos/400/600'} className="w-full h-auto block" />
                                    </div>
                                    <div className="grid grid-cols-4 gap-6">
                                        {(selectedProd.images || []).slice(1).map((img, i) => (
                                            <div key={i} className="bg-transparent border border-gray-100 shadow-xl overflow-hidden relative">
                                                <img src={img} className="w-full h-auto block" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-20">
                                    <div className="border-b pb-12 border-gray-100">
                                        <h2 className="text-2xl font-light tracking-[0.075em] uppercase mb-4">{selectedProd.name}</h2>
                                        <p className="text-grey-medium tracking-[0.125em] text-sm uppercase font-light mb-8">KRW {selectedProd.price}</p>
                                        <div className="text-sm leading-relaxed text-grey-dark font-light" dangerouslySetInnerHTML={{ __html: (selectedProd.description || '').replace(/\n/g, '<br/>') }} />
                                    </div>
                                    <div className="space-y-10">
                                        <p className="text-[11px] tracking-[0.125em] uppercase font-bold">Size Preference</p>
                                        <div className="flex flex-wrap gap-5">
                                            {(selectedProd.options || []).map(s => (
                                                <button key={s} onClick={() => setSelectedSize(s)} className={`min-w-[100px] py-4 border tracking-[0.1em] text-[11px] font-bold transition-all ${selectedSize === s ? 'bg-black text-white border-black shadow-2xl scale-110' : 'border-gray-200 hover:border-black'}`}>{s}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-10">
                                        <button onClick={addToCart} className="w-full bg-black text-white py-8 text-[11px] tracking-[0.15em] font-bold shadow-2xl active:scale-[0.98] uppercase">Add to My Selection</button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    )}
                    {view === 'cart' && (
                        <main className="max-w-2xl mx-auto px-10 pt-16 animate-fade-in">
                            <button onClick={() => handleNav('lookbook')} className="text-[11px] tracking-[0.1em] uppercase mb-24 flex items-center hover:text-gray-400 font-bold"><Icons.ChevronLeft size={18} className="mr-1" /> Back</button>
                            <div className="flex justify-between items-end border-b pb-10 mb-20 border-gray-100">
                                <h2 className="text-xs font-bold uppercase tracking-[0.125em]">Selected List</h2>
                                <p className="text-[10px] text-grey-medium font-bold uppercase tracking-[0.05em]">{cart.length} / {currentLimit}</p>
                            </div>
                            <div className="space-y-16 mb-32">
                                {cart.map((item, i) => (
                                    <div key={i} className="flex space-x-10 items-center group">
                                        <div className="w-28 bg-transparent shadow-2xl overflow-hidden relative">
                                            <img src={item.image} className="w-full h-auto block" />
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="text-[12px] font-normal uppercase mb-3">{item.productName}</h4>
                                            <p className="text-[10px] text-grey-medium tracking-[0.1em] uppercase">Size: <span className="text-black ml-2 font-bold">{item.size}</span></p>
                                        </div>
                                        <button onClick={() => setCart(cart.filter((_, idx) => idx !== i))} className="text-gray-300 hover:text-red-500 transition-all p-4"><Icons.X size={24} /></button>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-transparent p-12 space-y-16 shadow-2xl rounded-sm border border-gray-100">
                                <h3 className="text-[11px] font-bold uppercase tracking-[0.125em] border-b pb-8 border-gray-200">Shipping Info</h3>
                                <div className="space-y-10">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-10">
                                        <input placeholder="INSTAGRAM (@)" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.instagramId} onChange={e => setFormData({...formData, instagramId: e.target.value})} />
                                        <input placeholder="NAME" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-10">
                                        <input placeholder="PHONE" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                                        <input placeholder="ADDRESS" className="w-full border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none uppercase" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} />
                                    </div>
                                    <textarea placeholder="MESSAGE" className="w-full h-32 border-b border-gray-200 bg-transparent py-5 text-[11px] outline-none resize-none uppercase" value={formData.message} onChange={e => setFormData({...formData, message: e.target.value})} />
                                    
                                    <div className="flex items-start space-x-4 cursor-pointer group py-2">
                                        <input type="checkbox" id="agreement" className="mt-1 w-5 h-5 accent-black cursor-pointer" checked={formData.agreed} onChange={e => setFormData({...formData, agreed: e.target.checked})} />
                                        <label htmlFor="agreement" className="text-[11px] text-black font-medium leading-relaxed select-none cursor-pointer uppercase">
                                            *재고 상황 등에 따라 일부 내용이 달라질 수 있으며, 올려주신 콘텐츠는 브랜드 소개나 홍보에 활용될 수 있음에 동의합니다.
                                        </label>
                                    </div>
                                    <button onClick={submit} className="w-full bg-black text-white py-8 text-[11px] tracking-[0.15em] font-bold shadow-2xl disabled:opacity-30 uppercase transition-all" disabled={!cart.length || !formData.agreed}>제출하기</button>
                                </div>
                            </div>
                        </main>
                    )}
                    <SyncMonitor />
                    <Toast error={error} success={success} />
                </div>
            );
        };

        const App = () => {
            const [state, setState] = useState({ collections: [], adminAccessCode: 'admin' });
            const [isLoading, setIsLoading] = useState(true);
            const [view, setView] = useState('login');
            const [activeCollection, setActiveCollection] = useState(null);
            const [accessCodeInput, setAccessCodeInput] = useState('');
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [cart, setCart] = useState([]);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [newCollectionName, setNewCollectionName] = useState('');
            const [adminSubView, setAdminSubView] = useState('settings');
            const scrollPosRef = useRef(0);
            
            useEffect(() => {
                const configUnsub = db.collection('config').doc('global').onSnapshot(doc => {
                    if (doc.exists) {
                        setState(s => ({ ...s, adminAccessCode: doc.data().adminAccessCode || 'admin' }));
                    } else {
                        db.collection('config').doc('global').set({ adminAccessCode: 'admin' });
                    }
                });

                const collUnsub = db.collection('collections').onSnapshot(querySnapshot => {
                    const colls = [];
                    querySnapshot.forEach(doc => colls.push({ ...doc.data(), firebaseId: doc.id }));
                    setState(s => ({ ...s, collections: colls }));
                    setIsLoading(false);
                });

                return () => {
                    configUnsub();
                    collUnsub();
                };
            }, []);

            useEffect(() => {
                if (activeCollection) {
                    const latest = state.collections.find(c => c.id === activeCollection.id);
                    if (latest) setActiveCollection(latest);
                }
            }, [state.collections]);
            
            const notify = (msg, type) => { 
                if (type === 'success') { setSuccess(msg); setTimeout(() => setSuccess(null), 3000); } 
                else { setError(msg); setTimeout(() => setError(null), 3000); } 
            };

            const handleLogin = () => {
                const code = accessCodeInput.trim().toLowerCase();
                if (code === state.adminAccessCode.toLowerCase().trim()) { 
                    setView('select_collection'); 
                } else {
                    const matched = state.collections.find(c => (c.accessCodesV2 || []).some(ac => ac.code && ac.code.toLowerCase().trim() === code));
                    if (matched) { 
                        setActiveCollection(matched); 
                        setView('influencer'); 
                    } else {
                        notify('Invalid Access Code', 'error');
                    }
                }
            };

            const handleLogout = () => { setActiveCollection(null); setView('login'); setAccessCodeInput(''); setCart([]); scrollPosRef.current = 0; };
            
            const createCollection = async (name) => {
                if (!name.trim()) return;
                const newColl = {
                    id: generateId(),
                    name: name.trim(),
                    accessCodesV2: [{ code: generateId().substring(0, 6), limit: 2 }],
                    lookbookImages: [],
                    descriptionTitle: 'New Story',
                    descriptionBody: 'Collection inspiration...',
                    products: [],
                    shippingEntries: []
                };
                try {
                    await db.collection('collections').add(newColl);
                    setIsCreateModalOpen(false);
                    setNewCollectionName('');
                    notify('Collection Created', 'success');
                } catch (err) {
                    notify('Cloud Save Failed', 'error');
                }
            };

            const updateCollection = async (updated) => {
                try {
                    const docId = updated.firebaseId;
                    if (!docId) return;
                    const dataToSave = { ...updated };
                    delete dataToSave.firebaseId;
                    await db.collection('collections').doc(docId).set(dataToSave);
                } catch (err) {
                    notify('Cloud Update Failed', 'error');
                }
            };

            const deleteCollection = async (docId) => {
                try {
                    await db.collection('collections').doc(docId).delete();
                    setView('select_collection');
                    notify('컬렉션이 안전하게 삭제되었습니다.', 'success');
                } catch (err) {
                    notify('Delete Failed', 'error');
                }
            };

            const updateAdminCode = (newCode) => {
                db.collection('config').doc('global').update({ adminAccessCode: newCode });
            };

            if (isLoading) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white space-y-6">
                    <div className="loader w-12 h-12"></div>
                    <span className="text-[10px] tracking-[0.125em] uppercase font-bold animate-pulse">nuuanu cloud initializing</span>
                </div>
            );
            
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-white animate-fade-in"><div className="max-w-md w-full text-center space-y-20"><h1 className="text-6xl font-light tracking-[0.1em] uppercase">nuuanu</h1><div className="space-y-6"><input type="text" placeholder="ACCESS CODE" className="w-full border-b border-gray-200 py-4 text-center focus:outline-none focus:border-black tracking-[0.075em] uppercase text-sm bg-transparent transition-colors" value={accessCodeInput} onChange={e => setAccessCodeInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} autoFocus /><button onClick={handleLogin} className="w-full bg-black text-white py-5 text-[10px] tracking-[0.125em] uppercase font-bold transition-all hover:bg-black/90 active:scale-95">Entrance</button></div></div><Toast error={error} success={success} /></div>
            );

            if (view === 'select_collection') return (
                <div className="min-h-screen bg-white p-10 sm:p-20 animate-fade-in"><div className="max-w-6xl mx-auto space-y-16"><div className="flex justify-between items-end border-b border-gray-100 pb-10"><div><h2 className="text-[10px] tracking-[0.1em] uppercase text-grey-medium mb-2">Management</h2><h1 className="text-4xl font-light tracking-normal uppercase">Collections</h1></div><button onClick={handleLogout} className="text-[10px] uppercase tracking-[0.075em] border-b border-black pb-1 transition-colors">Logout</button></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    {state.collections.map(c => (
                        <div key={c.id} className="relative group"><div onClick={() => { setActiveCollection(c); setAdminSubView('settings'); setView('admin'); }} className="border border-gray-100 p-12 hover:border-black transition-all cursor-pointer flex flex-col items-center justify-center space-y-6 aspect-square bg-white shadow-sm hover:shadow-xl"><div className="w-16 h-16 bg-transparent flex items-center justify-center rounded-full group-hover:bg-black group-hover:text-white transition-all"><Icons.Package size={24}/></div><div className="text-center font-bold tracking-normal uppercase text-xs">{c.name}</div></div></div>
                    ))}
                    <button onClick={() => setIsCreateModalOpen(true)} className="border border-dashed border-gray-200 p-12 hover:border-black hover:bg-gray-50 flex flex-col items-center justify-center space-y-6 aspect-square group text-gray-300 hover:text-black transition-all"><Icons.Plus size={24}/><span className="text-[10px] uppercase font-bold">New Catalog</span></button>
                </div></div>
                {isCreateModalOpen && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 px-6 backdrop-blur-sm" onClick={() => setIsCreateModalOpen(false)}><div className="bg-white p-12 w-full max-w-sm shadow-2xl space-y-12 animate-fade-in" onClick={e => e.stopPropagation()}><h3 className="text-xs font-bold uppercase border-b pb-4 text-center tracking-normal">New Seeding Catalog</h3><input autoFocus type="text" placeholder="NAME" className="w-full border-b border-gray-200 py-4 text-center focus:border-black outline-none uppercase text-sm tracking-normal" value={newCollectionName} onChange={e => setNewCollectionName(e.target.value)} onKeyDown={e => e.key === 'Enter' && createCollection(newCollectionName)} /><button onClick={() => createCollection(newCollectionName)} className="w-full bg-black text-white py-5 text-[10px] uppercase font-bold tracking-[0.1em]">Confirm Create</button></div></div>)}<SyncMonitor /><Toast error={error} success={success} /></div>
            );

            if (view === 'admin' && activeCollection) return (<AdminDashboard collection={activeCollection} collections={state.collections} onUpdate={updateCollection} onBack={() => setView('select_collection')} activeSubView={adminSubView} setSubView={setAdminSubView} notify={notify} adminAccessCode={state.adminAccessCode} updateAdminCode={updateAdminCode} error={error} success={success} onDelete={() => deleteCollection(activeCollection.firebaseId)} />);
            
            if (view === 'influencer' && activeCollection) return (<InfluencerPage collection={activeCollection} cart={cart} setCart={setCart} onLogout={handleLogout} notify={notify} scrollPosRef={scrollPosRef} onSubmission={entries => updateCollection({ ...activeCollection, shippingEntries: [...(activeCollection.shippingEntries || []), ...entries] })} error={error} success={success} loginCode={accessCodeInput} />);
            
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
